{% extends "base.html" %}

{% block title %}Dashboard - Controle Financeiro{% endblock %}

{% block page_title %}Dashboard{% endblock %}

{% block navbar_extra %}
<form action="{{ url_for('dashboard') }}" method="GET" class="d-flex filter-form-dashboard" id="filterFormDashboard" style="display: flex !important; align-items: center !important; gap: 8px !important; margin: 0 !important; flex-shrink: 0 !important;">
    <input type="month" name="filtro_mes" class="form-control" value="{{ filtro_atual }}" onchange="this.form.submit()">
    <button class="btn btn-primary filter-submit-btn" type="submit" title="Filtrar">
        <i class="fas fa-filter"></i>
    </button>
</form>
{% endblock %}

{% block content %}
<style>
    /* ========================================
       FORMUL√ÅRIO DASHBOARD - CONFORT√ÅVEL E LEG√çVEL
       Fontes maiores, campos espa√ßados, bot√£o full-width
       ======================================== */
    
    /* Desktop: Formul√°rio confort√°vel */
    form[action*="add_lancamento"] .form-label {
        font-size: 0.9rem;
        font-weight: 500;
        margin-bottom: 0.4rem;
        color: var(--text-primary);
    }
    
    form[action*="add_lancamento"] .form-control,
    form[action*="add_lancamento"] .form-select {
        font-size: 1rem;
        padding: 0.6rem 0.75rem;
        height: auto;
        min-height: 42px;
    }
    
    /* Bot√£o sempre full-width e destacado */
    form[action*="add_lancamento"] button[type="submit"] {
        width: 100% !important;
        min-height: 50px !important;
        font-size: 1.1rem !important;
        font-weight: 600 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        gap: 10px !important;
        border-radius: 8px !important;
        margin-top: 0.5rem;
    }
    
    /* Mobile e Tablet */
    @media (max-width: 991px) {
        form[action*="add_lancamento"] .row {
            display: flex !important;
            flex-wrap: wrap !important;
            gap: 0.75rem !important;
        }
        
        /* Campos em pares */
        form[action*="add_lancamento"] .row > .col-6 {
            flex: 0 0 calc(50% - 0.375rem) !important;
            width: calc(50% - 0.375rem) !important;
            max-width: calc(50% - 0.375rem) !important;
        }
        
        /* Campo Valor: Largura total */
        form[action*="add_lancamento"] .row > div.col-12:not(:last-child) {
            flex: 0 0 100% !important;
            width: 100% !important;
        }
        
        /* Bot√£o: Linha exclusiva */
        form[action*="add_lancamento"] .row > div.col-12.mt-2,
        form[action*="add_lancamento"] .row > .col-12:last-of-type {
            flex: 0 0 100% !important;
            width: 100% !important;
            margin-top: 1rem !important;
        }
    }
    
    /* Mobile: Fontes confort√°veis */
    @media (max-width: 767px) {
        form[action*="add_lancamento"] .form-label {
            font-size: 0.875rem;
            margin-bottom: 0.35rem;
        }
        
        form[action*="add_lancamento"] .form-control,
        form[action*="add_lancamento"] .form-select {
            font-size: 1rem;
            padding: 0.55rem 0.65rem;
            min-height: 44px;
        }
        
        form[action*="add_lancamento"] button[type="submit"] {
            min-height: 52px !important;
            font-size: 1.05rem !important;
        }
    }
    
    /* ========================================
       LEGENDA CUSTOMIZADA DO GR√ÅFICO - GRID 2 COLUNAS IGUAIS
       TEXTO BRANCO NO MODO ESCURO (#FFFFFF)
       ======================================== */
    
    /* Container da legenda customizada - GRID 2 COLUNAS EQUILIBRADAS */
    #categoryLegend {
        display: grid !important;
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 8px 12px !important;
        align-content: start !important;
        justify-items: start !important;
    }
    
    /* Itens da legenda - DIN√ÇMICO: Preto no modo claro, Branco no modo escuro */
    #categoryLegend div {
        display: flex !important;
        align-items: center !important;
        gap: 6px !important;
        font-size: 11px !important;
        width: 100% !important;
        max-width: 100% !important;
        overflow: hidden !important;
    }
    
    /* Bolinha colorida da legenda */
    #categoryLegend div span:first-child {
        width: 10px !important;
        height: 10px !important;
        min-width: 10px !important;
        min-height: 10px !important;
        border-radius: 50% !important;
        flex-shrink: 0 !important;
    }
    
    /* Texto da legenda - Modo claro: preto */
    #categoryLegend div,
    #categoryLegend div span:last-child {
        color: #2d3748 !important;
    }
    
    /* Texto da categoria - truncar com ellipsis */
    #categoryLegend div span:last-child {
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        max-width: calc(100% - 20px) !important;
    }
    
    /* Modo escuro: texto BRANCO FOR√áADO */
    [data-theme="dark"] #categoryLegend div,
    [data-theme="dark"] #categoryLegend div span:last-child {
        color: #FFFFFF !important;
    }
    
    /* Mobile: ajustes de tamanho */
    @media (max-width: 767px) {
        #categoryLegend {
            gap: 5px 8px !important;
        }
        
        #categoryLegend div {
            font-size: 9px !important;
        }
        
        #categoryLegend div span:first-child {
            width: 8px !important;
            height: 8px !important;
            min-width: 8px !important;
            min-height: 8px !important;
        }
        
        #categoryLegend div span:last-child {
            max-width: calc(100% - 16px) !important;
        }
    }
    
    /* ========================================
       TABELA RESPONSIVA - Dashboard
       ======================================== */
    
    /* For√ßar linha √∫nica na tabela */
    #lancamentos-table tbody tr td {
        white-space: nowrap !important;
        vertical-align: middle !important;
    }
    
    /* Coluna de valor - nunca quebra linha */
    .col-valor .valor-texto {
        white-space: nowrap !important;
    }
    
    /* Coluna de categoria - SEM cortar texto na tabela */
    .col-categoria {
        max-width: 180px !important;
        overflow: visible !important;
    }
    
    .col-categoria .categoria-texto {
        display: inline-block;
        max-width: 100px;
        white-space: nowrap;
        overflow: visible !important;
        vertical-align: middle;
    }
    
    /* Badge de meta */
    .badge-meta {
        font-size: 0.55rem !important;
        vertical-align: middle;
        padding: 0.15rem 0.35rem !important;
    }
    
    /* Bot√µes de a√ß√£o - SEMPRE em linha horizontal */
    .btn-group-acoes {
        display: inline-flex !important;
        flex-direction: row !important;
        flex-wrap: nowrap !important;
        gap: 3px !important;
        justify-content: center !important;
    }
    
    .btn-group-acoes .btn {
        flex-shrink: 0 !important;
        padding: 0.25rem 0.4rem !important;
    }
    
    .col-acoes {
        min-width: 100px !important;
        white-space: nowrap !important;
    }
    
    /* ========================================
       FORMUL√ÅRIO DE NOVO LAN√áAMENTO - RESPONSIVO
       Desktop: Grid 3 colunas
       Tablet: Grid 2 colunas
       Mobile: Grid 2 ou 1 coluna
       ======================================== */
    
    /* ========================================
       DESKTOP (> 1024px) - Grid 3 Colunas
       ======================================== */
    @media (min-width: 1025px) {
        /* Desktop: Grid de 3 colunas */
        form[action*="add_lancamento"] .row {
            display: grid !important;
            grid-template-columns: repeat(3, 1fr) !important;
            gap: 15px !important;
            align-items: start !important;
        }
        
        /* Cada campo ocupa 1 coluna */
        form[action*="add_lancamento"] .col-md-2,
        form[action*="add_lancamento"] .col-md-1,
        form[action*="add_lancamento"] .col-6,
        form[action*="add_lancamento"] .col-12 {
            grid-column: span 1 !important;
            width: 100% !important;
            max-width: none !important;
        }
        
        /* Bot√£o: ocupa 3 colunas (largura total) */
        form[action*="add_lancamento"] .col-md-1:last-child {
            grid-column: span 3 !important;
        }
        
        /* Labels: alinhados √† esquerda, acima do campo */
        form[action*="add_lancamento"] .form-label {
            font-size: 0.875rem !important;
            font-weight: 500 !important;
            margin-bottom: 0.4rem !important;
            text-align: left !important;
            display: block !important;
        }
        
        /* Padroniza√ß√£o dos inputs e selects */
        form[action*="add_lancamento"] .form-control,
        form[action*="add_lancamento"] .form-select {
            width: 100% !important;
            height: 40px !important;
            max-width: none !important;
            font-size: 0.9rem !important;
            padding: 0.5rem 0.75rem !important;
            border-radius: 6px !important;
            box-sizing: border-box !important;
        }
        
        /* Bot√£o adicionar: grande, verde, retangular, √≠cone centralizado */
        form[action*="add_lancamento"] button[type="submit"] {
            width: 100% !important;
            height: 48px !important;
            padding: 0 1.5rem !important;
            font-size: 1.1rem !important;
            font-weight: 700 !important;
            background-color: #28a745 !important;
            border-color: #28a745 !important;
            color: white !important;
            border-radius: 8px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 10px !important;
        }
        
        form[action*="add_lancamento"] button[type="submit"]:hover {
            background-color: #218838 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.35);
        }
        
        form[action*="add_lancamento"] button[type="submit"] i {
            font-size: 1.3rem !important;
        }
    }
    
    /* ========================================
       TABLETS (768px - 1024px) - Grid 2 Colunas
       ======================================== */
    @media (min-width: 768px) and (max-width: 1024px) {
        /* Tablet: Grid de 2 colunas */
        form[action*="add_lancamento"] .row {
            display: grid !important;
            grid-template-columns: 1fr 1fr !important;
            gap: 15px !important;
            align-items: start !important;
        }
        
        /* Cada campo ocupa 1 coluna */
        form[action*="add_lancamento"] .col-md-2,
        form[action*="add_lancamento"] .col-md-1,
        form[action*="add_lancamento"] .col-6,
        form[action*="add_lancamento"] .col-12 {
            grid-column: span 1 !important;
            width: 100% !important;
            max-width: none !important;
        }
        
        /* Bot√£o: ocupa 2 colunas (largura total) */
        form[action*="add_lancamento"] .col-md-1:last-child {
            grid-column: span 2 !important;
        }
        
        /* Labels: alinhados √† esquerda, acima do campo */
        form[action*="add_lancamento"] .form-label {
            font-size: 0.875rem !important;
            font-weight: 500 !important;
            margin-bottom: 0.4rem !important;
            text-align: left !important;
            display: block !important;
        }
        
        /* Padroniza√ß√£o dos inputs e selects */
        form[action*="add_lancamento"] .form-control,
        form[action*="add_lancamento"] .form-select {
            width: 100% !important;
            height: 40px !important;
            max-width: none !important;
            font-size: 0.9rem !important;
            padding: 0.5rem 0.75rem !important;
            border-radius: 6px !important;
            box-sizing: border-box !important;
        }
        
        /* Bot√£o adicionar: grande, verde, retangular, √≠cone centralizado */
        form[action*="add_lancamento"] button[type="submit"] {
            width: 100% !important;
            height: 48px !important;
            padding: 0 1.5rem !important;
            font-size: 1.1rem !important;
            font-weight: 700 !important;
            background-color: #28a745 !important;
            border-color: #28a745 !important;
            color: white !important;
            border-radius: 8px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 10px !important;
        }
        
        form[action*="add_lancamento"] button[type="submit"]:hover {
            background-color: #218838 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.35);
        }
        
        form[action*="add_lancamento"] button[type="submit"] i {
            font-size: 1.3rem !important;
        }
        
        /* Esconde badge de meta em tablets menores */
        .badge-meta {
            display: none !important;
        }
        
        /* Categoria com menos largura */
        .col-categoria {
            max-width: 100px !important;
        }
        
        .col-categoria .categoria-texto {
            max-width: 80px;
        }
        
        /* Coluna de data mais compacta */
        .col-data {
            font-size: 0.8rem;
        }
        
        /* Bot√µes menores */
        .btn-group-acoes .btn {
            padding: 0.2rem 0.35rem !important;
            font-size: 0.7rem !important;
        }
        
        .col-acoes {
            min-width: 90px !important;
        }
    }
    
    /* ========================================
       TABLETS PEQUENOS / LANDSCAPE PHONES
       ======================================== */
    @media (max-width: 991px) {
        /* Formul√°rio compacto */
        form[action*="add_lancamento"] .form-label {
            font-size: 0.75rem !important;
        }
        
        form[action*="add_lancamento"] .form-control,
        form[action*="add_lancamento"] .form-select {
            font-size: 0.8rem !important;
        }
        
        /* Esconde badge de meta */
        .badge-meta {
            display: none !important;
        }
        
        /* Coluna de categoria mais estreita */
        .col-categoria .categoria-texto {
            max-width: 70px;
        }
    }
    
    /* ========================================
       MOBILE M√âDIO (480px - 767px)
       CSS do formul√°rio gerenciado no topo
       ======================================== */
    @media (min-width: 480px) and (max-width: 767px) {
        /* FORMUL√ÅRIO - CSS REMOVIDO (usado CSS no topo do arquivo) */
    }
    
    /* ========================================
       MOBILE PEQUENO (< 480px)
       CSS do formul√°rio gerenciado no topo
       ======================================== */
    @media (max-width: 479px) {
        /* FORMUL√ÅRIO - CSS REMOVIDO (usado CSS no topo do arquivo) */
        
        /* Esconder tabela, mostrar cards */
        .desktop-table {
            display: none !important;
        }
        
        .mobile-transaction-cards {
            display: block !important;
        }
        
        /* Cabe√ßalho Dashboard - iPhone Ultra-Compacto */
        .page-title-section h1 {
            font-size: 1.4rem !important;
        }
        
        .page-title-section .text-muted {
            font-size: 0.8rem !important;
        }
        
        /* √çCONES COLADOS - gap 2px, SEM margin-left: auto */
        .navbar-actions {
            gap: 2px !important;
            margin-left: 0 !important;
            margin-right: 0 !important;
            padding-right: 0 !important;
        }
        
        .top-navbar {
            justify-content: space-between !important;
            padding-left: 0.5rem !important;
            padding-right: 0.5rem !important;
            width: 100% !important;
        }
        
        .top-navbar .d-flex.align-items-center.gap-3 {
            gap: 4px !important;
            flex-shrink: 0 !important;
            margin-right: 0 !important;
        }
        
        /* Bot√µes menores no cabe√ßalho mobile */
        .btn-privacy-toggle,
        .btn-theme-toggle,
        .btn-actions-toggle {
            padding: 0.25rem 0.4rem !important;
            font-size: 0.8rem !important;
            width: 32px !important;
            height: 32px !important;
            min-width: 32px !important;
        }
        
        /* Form do filtro mais compacto */
        form[action*="dashboard"] {
            gap: 2px !important;
        }
        
        .navbar .month-selector,
        .month-selector {
            max-width: 95px !important;
            font-size: 0.7rem !important;
            padding: 0.2rem 0.35rem !important;
        }
        
        form[action*="dashboard"] .btn-primary {
            padding: 0.3rem 0.5rem !important;
            font-size: 0.85rem !important;
        }
        
        /* FORMUL√ÅRIO MOBILE - CSS REMOVIDO (usado CSS no topo do arquivo) */
        
        form[action*="add_lancamento"] .form-label {
            font-size: 0.7rem !important;
            margin-bottom: 0.2rem !important;
        }
    }
    
    @media (min-width: 768px) {
        .mobile-transaction-cards {
            display: none !important;
        }
        
        /* Formul√°rio PC: 3 colunas x 2 linhas */
        form[action*="add_lancamento"] .row {
            display: grid !important;
            grid-template-columns: repeat(3, 1fr) !important;
            gap: 1rem !important;
            align-items: start !important;
        }
        
        /* Data, Tipo, Categoria - Linha 1 */
        form[action*="add_lancamento"] .col-6:nth-child(1),
        form[action*="add_lancamento"] .col-6:nth-child(2),
        form[action*="add_lancamento"] .col-6:nth-child(3) {
            grid-column: span 1 !important;
        }
        
        /* Classifica√ß√£o, Valor, Meta - Linha 2 */
        form[action*="add_lancamento"] .col-6:nth-child(4),
        form[action*="add_lancamento"] .col-6:nth-child(5),
        form[action*="add_lancamento"] .col-12:nth-child(6) {
            grid-column: span 1 !important;
        }
        
        /* Bot√£o (+) - Linha 3, largura total */
        form[action*="add_lancamento"] .col-12:last-child {
            grid-column: span 3 !important;
        }
    }
</style>

<!-- Stats Cards - Responsive Grid com Espa√ßamento Adequado -->
<div class="row g-2 g-md-4" style="margin-bottom: 2rem !important;">
        <div class="col-12 col-sm-4">
            <div class="card stat-card entrada">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start flex-column flex-sm-row">
                        <div class="flex-grow-1" style="min-width: 0;">
                            <p class="stat-label mb-1">Entradas</p>
                            <h3 class="stat-value privacy-mask mb-0" style="font-size: clamp(0.9rem, 3.5vw, 1.5rem) !important; font-weight: 800 !important; line-height: 1.2 !important; white-space: nowrap !important;">R$ {{ "%.2f"|format(entrada) }}</h3>
                            <small class="d-none d-md-inline" style="color: #ffffff !important;">
                                <i class="fas fa-arrow-{{ 'up' if trend_ent_pct > 0 else 'down' }}"></i>
                                {{ "%.0f"|format(trend_ent_pct|abs) }}%
                            </small>
                        </div>
                        <div class="stat-icon d-none d-sm-flex">
                            <i class="fas fa-arrow-up"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-4">
            <div class="card stat-card saida">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start flex-column flex-sm-row">
                        <div class="flex-grow-1" style="min-width: 0;">
                            <p class="stat-label mb-1">Sa√≠das</p>
                            <h3 class="stat-value privacy-mask mb-0" style="font-size: clamp(0.9rem, 3.5vw, 1.5rem) !important; font-weight: 800 !important; line-height: 1.2 !important; white-space: nowrap !important;">R$ {{ "%.2f"|format(saida|abs) }}</h3>
                            <small class="d-none d-md-inline" style="color: #ffffff !important;">
                                <i class="fas fa-arrow-{{ 'up' if trend_sai_pct > 0 else 'down' }}"></i>
                                {{ "%.0f"|format(trend_sai_pct|abs) }}%
                            </small>
                        </div>
                        <div class="stat-icon d-none d-sm-flex">
                            <i class="fas fa-arrow-down"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-4">
            <div class="card stat-card saldo">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start flex-column flex-sm-row">
                        <div class="flex-grow-1" style="min-width: 0;">
                            <p class="stat-label mb-1">Saldo</p>
                            <h3 class="stat-value privacy-mask mb-0" style="font-size: clamp(0.9rem, 3.5vw, 1.5rem) !important; font-weight: 800 !important; line-height: 1.2 !important; white-space: nowrap !important; color: #ffffff !important;">
                                R$ {{ "%.2f"|format(saldo) }}
                            </h3>
                        </div>
                        <div class="stat-icon d-none d-sm-flex">
                            <i class="fas fa-wallet"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- Charts Row -->
<div class="row g-4 mb-4">
    <!-- Category Chart -->
    <div class="col-lg-5">
        <div class="card h-100">
            <div class="card-header">
                <i class="fas fa-chart-pie me-2"></i>Gastos por Categoria
            </div>
            <div class="card-body">
                <div class="d-flex align-items-start" style="gap: 15px;">
                    <!-- Gr√°fico de Pizza -->
                    <div style="width: 45%; min-width: 120px; height: 200px;">
                        <canvas id="categoryChart"></canvas>
                    </div>
                    <!-- Legenda Customizada em Grid 2 Colunas -->
                    <div id="categoryLegend" style="flex: 1; display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; align-content: start;"></div>
                </div>
                
                <!-- Macro Summary (50-30-20) -->
                <div class="mt-4 pt-3" style="border-top: 1px solid var(--border-color);">
                    <h6 class="mb-3">Regra 50-30-20</h6>
                    {% set tot = entrada if entrada > 0 else 1 %}
                    
                    <div class="mb-2">
                        <div class="d-flex justify-content-between small mb-1">
                            <span>Essenciais (50%)</span>
                            <span class="privacy-mask">{{ "%.0f"|format((macro_vals['ESSENCIAIS']/tot)*100) }}%</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-danger" style="width: {{ (macro_vals['ESSENCIAIS']/tot)*100 }}%"></div>
                        </div>
                    </div>
                    
                    <div class="mb-2">
                        <div class="d-flex justify-content-between small mb-1">
                            <span>Estilo de Vida (30%)</span>
                            <span class="privacy-mask">{{ "%.0f"|format((macro_vals['ESTILO_VIDA']/tot)*100) }}%</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-warning" style="width: {{ (macro_vals['ESTILO_VIDA']/tot)*100 }}%"></div>
                        </div>
                    </div>
                    
                    <div class="mb-2">
                        <div class="d-flex justify-content-between small mb-1">
                            <span>Investimentos (20%)</span>
                            <span class="privacy-mask">{{ "%.0f"|format((macro_vals['INVESTIMENTOS']/tot)*100) }}%</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-success" style="width: {{ (macro_vals['INVESTIMENTOS']/tot)*100 }}%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Daily Chart -->
    <div class="col-lg-7">
        <div class="card h-100">
            <div class="card-header">
                <i class="fas fa-chart-bar me-2"></i>Movimenta√ß√£o Di√°ria
            </div>
            <div class="card-body">
                <div style="height: 340px;">
                    <canvas id="dailyChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Transaction Form -->
<div class="card mb-4">
    <div class="card-header">
        <i class="fas fa-plus-circle me-2"></i>Novo Lan√ßamento
    </div>
    <div class="card-body">
        <form action="{{ url_for('add_lancamento') }}" method="POST">
            <div class="row g-3">
                <!-- Linha 1: Data | Tipo -->
                <div class="col-6 col-md-4 col-lg-2">
                    <label class="form-label">Data</label>
                    <input type="text" name="data" class="form-control date-mask" value="{{ hoje_br }}" required>
                </div>
                <div class="col-6 col-md-4 col-lg-2">
                    <label class="form-label">Tipo</label>
                    <select name="tipo" class="form-select">
                        <option value="SAIDA">Sa√≠da</option>
                        <option value="ENTRADA">Entrada</option>
                    </select>
                </div>
                <!-- Linha 2: Classifica√ß√£o | Categoria -->
                <div class="col-6 col-md-4 col-lg-2">
                    <label class="form-label">Classifica√ß√£o</label>
                    <select name="classificacao" class="form-select">
                        <option value="Essenciais">Essenciais</option>
                        <option value="Estilo de Vida">Estilo de Vida</option>
                        <option value="Investimentos">Investimentos</option>
                    </select>
                </div>
                <div class="col-6 col-md-6 col-lg-3">
                    <label class="form-label">Categoria</label>
                    <input name="categoria" class="form-control" list="categorias-list" required placeholder="Ex: Mercado">
                    <datalist id="categorias-list">
                        {% for cat in all_categories %}
                        <option value="{{ cat }}">
                        {% endfor %}
                    </datalist>
                </div>
                <!-- Linha 3: Valor -->
                <div class="col-12 col-md-6 col-lg-3">
                    <label class="form-label">Valor (R$)</label>
                    <input type="number" step="0.01" name="valor" class="form-control" required placeholder="0.00">
                </div>
                <!-- V√≠nculo de Meta (opcional) -->
                <input type="hidden" name="meta_id" value="">
                <!-- Linha Final: Bot√£o Full-Width -->
                <div class="col-12 mt-2">
                    <button type="submit" class="btn w-100" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: none; color: #ffffff; font-weight: 600; font-size: 1.1rem; min-height: 50px;">
                        <i class="fas fa-plus me-2"></i>Adicionar Lan√ßamento
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Transactions Section -->
    </div>
</div>

<!-- Transactions Section -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
        <span><i class="fas fa-list me-2"></i>Lan√ßamentos</span>
        <div class="d-flex gap-2 align-items-center flex-wrap">
            <input type="text" id="search-input" class="form-control form-control-sm" placeholder="Buscar..." style="width: 150px;">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-secondary btn-filter btn-sm active" data-filter="all">Todos</button>
                <button type="button" class="btn btn-outline-secondary btn-filter btn-sm" data-filter="ENTRADA"><span class="d-none d-sm-inline">Entradas</span><span class="d-sm-none">+</span></button>
                <button type="button" class="btn btn-outline-secondary btn-filter btn-sm" data-filter="SAIDA"><span class="d-none d-sm-inline">Sa√≠das</span><span class="d-sm-none">-</span></button>
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        <!-- Desktop Table View -->
        <div class="table-responsive desktop-table">
            <table class="table table-hover mb-0" id="lancamentos-table">
                <thead>
                    <tr>
                        <th style="width: 50px;" class="text-center">
                            <i class="fas fa-check-circle"></i>
                        </th>
                        <th>Lan√ßamento</th>
                        <th>Data</th>
                        <th class="text-end col-valor">Valor</th>
                        <th class="text-center col-acoes">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for l in dados_exibicao %}
                    <tr class="{% if l.Status == 'Pago' %}row-pago{% endif %}" 
                        data-tipo="{{ l.Tipo }}" 
                        data-categoria="{{ l.Categoria|lower }}">
                        <td class="text-center">
                            <a href="{{ url_for('toggle_status', id=l.ID, filtro_mes=filtro_atual) }}" 
                               class="btn-status {% if l.Status == 'Pago' %}pago{% endif %}">
                                <i class="fas fa-check"></i>
                            </a>
                        </td>
                        <td class="col-categoria">
                            <span class="categoria-texto">{{ l.Categoria }}</span>
                        </td>
                        <td class="col-data">{{ l.Data }}</td>
                        <td class="text-end col-valor privacy-mask fw-bold text-{{ 'success' if l.Valor > 0 else 'danger' }}">
                            <span class="valor-texto">R$&nbsp;{{ "%.2f"|format(l.Valor|abs) }}</span>
                        </td>
                        <td class="text-center col-acoes">
                            <div class="btn-group-acoes">
                                <a href="{{ url_for('pin_lancamento', lancamento_id=l.ID, filtro_mes=filtro_atual) }}" 
                                   class="btn btn-action btn-warning btn-pin {% if l.Fixado == 'Sim' %}fixado{% endif %}" 
                                   title="Fixar">
                                    <i class="fas fa-thumbtack"></i>
                                </a>
                                <a href="{{ url_for('edit_lancamento_form', lancamento_id=l.ID, filtro_mes=filtro_atual) }}" 
                                   class="btn btn-action btn-primary" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a href="{{ url_for('delete_lancamento', lancamento_id=l.ID, filtro_mes=filtro_atual) }}" 
                                   class="btn btn-action btn-danger" 
                                   onclick="return confirm('Excluir este lan√ßamento?')" title="Excluir">
                                    <i class="fas fa-trash"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                            Nenhum lan√ßamento neste m√™s
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Mobile Cards View -->
        <div class="mobile-transaction-cards p-3" id="mobile-cards">
            {% for l in dados_exibicao %}
            <div class="mobile-transaction-card {{ 'entrada' if l.Tipo == 'ENTRADA' else 'saida' }} {% if l.Status == 'Pago' %}opacity-75{% endif %}"
                 data-tipo="{{ l.Tipo }}" 
                 data-categoria="{{ l.Categoria|lower }}">
                <div class="transaction-header">
                    <div class="transaction-desc">
                        {{ l.Categoria }}
                    </div>
                    <div class="transaction-valor privacy-mask text-{{ 'success' if l.Valor > 0 else 'danger' }}">
                        {{ '+' if l.Valor > 0 else '-' }}R$ {{ "%.2f"|format(l.Valor|abs) }}
                    </div>
                </div>
                <div class="transaction-meta">
                    <span><i class="fas fa-calendar"></i> {{ l.Data }}</span>
                    {% if l.Status == 'Pago' %}
                    <span class="text-success"><i class="fas fa-check-circle"></i> Pago</span>
                    {% else %}
                    <span class="text-warning"><i class="fas fa-clock"></i> Pendente</span>
                    {% endif %}
                </div>
                <div class="transaction-actions">
                    <a href="{{ url_for('toggle_status', id=l.ID, filtro_mes=filtro_atual) }}" 
                       class="btn btn-sm btn-{{ 'success' if l.Status != 'Pago' else 'secondary' }}" 
                       title="{{ 'Marcar como pago' if l.Status != 'Pago' else 'Marcar como pendente' }}">
                        <i class="fas fa-check"></i>
                    </a>
                    <a href="{{ url_for('pin_lancamento', lancamento_id=l.ID, filtro_mes=filtro_atual) }}" 
                       class="btn btn-sm btn-warning" title="Fixar">
                        <i class="fas fa-thumbtack"></i>
                    </a>
                    <a href="{{ url_for('edit_lancamento_form', lancamento_id=l.ID, filtro_mes=filtro_atual) }}" 
                       class="btn btn-sm btn-primary" title="Editar">
                        <i class="fas fa-edit"></i>
                    </a>
                    <a href="{{ url_for('delete_lancamento', lancamento_id=l.ID, filtro_mes=filtro_atual) }}" 
                       class="btn btn-sm btn-danger" 
                       onclick="return confirm('Excluir?')" title="Excluir">
                        <i class="fas fa-trash"></i>
                    </a>
                </div>
            </div>
            {% else %}
            <div class="text-center text-muted py-4">
                <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                Nenhum lan√ßamento neste m√™s
            </div>
            {% endfor %}
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ P√°gina carregada - Inicializando gr√°ficos...');
    
    // ========================================
    // CHARTS
    // ========================================
    
    // Paleta de cores EXPANDIDA - 10 cores distintas para evitar repeti√ß√£o
    const colorPalette = [
        '#3498db', // Azul
        '#2ecc71', // Verde
        '#f1c40f', // Amarelo
        '#e74c3c', // Vermelho
        '#9b59b6', // Roxo
        '#1abc9c', // Turquesa
        '#e67e22', // Laranja
        '#34495e', // Cinza escuro
        '#7f8c8d', // Cinza m√©dio
        '#d35400'  // Laranja escuro
    ];
    
    console.log('‚úÖ Paleta de cores definida:', colorPalette);
    
    // Fun√ß√£o para distribuir cores
    function getChartColors(count) {
        const colors = [];
        for (let i = 0; i < count; i++) {
            colors.push(colorPalette[i % colorPalette.length]);
        }
        return colors;
    }
    
    // Category Chart - Gr√°fico de Gastos por Categoria
    try {
        const categoryCtx = document.getElementById('categoryChart');
        if (categoryCtx) {
            console.log('üìä Canvas encontrado:', categoryCtx);
            
            const categoryLabels = {{ chart_cats|safe }};
            const categoryData = {{ chart_vals|safe }};
            
            console.log('üìä GR√ÅFICO DE CATEGORIAS:');
            console.log('  - Labels:', categoryLabels);
            console.log('  - Valores:', categoryData);
            console.log('  - Total de categorias:', categoryLabels.length);
            
            if (categoryLabels.length === 0 || categoryData.length === 0) {
                console.warn('‚ö†Ô∏è Sem dados para o gr√°fico de categorias');
            } else {
                const categoryColors = getChartColors(categoryLabels.length);
                console.log('  - Cores aplicadas:', categoryColors);
                
                // Criar gr√°fico sem legenda nativa
                
                new Chart(categoryCtx.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: categoryLabels,
                datasets: [{
                    data: categoryData,
                    backgroundColor: categoryColors,
                    borderColor: 'transparent',
                    borderWidth: 0,
                    hoverOffset: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false // Desabilitar legenda nativa - usaremos HTML customizado
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        titleFont: {
                            size: 14,
                            weight: 'bold'
                        },
                        bodyFont: {
                            size: 13
                        },
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${label}: R$ ${value.toFixed(2)} (${percentage}%)`;
                            }
                        }
                    }
                },
                cutout: '60%'
            }
        });
        
        // CRIAR LEGENDA HTML CUSTOMIZADA com Grid 2 Colunas Exatas
        const legendContainer = document.getElementById('categoryLegend');
        if (legendContainer) {
            // Fun√ß√£o para truncar texto em N palavras (mobile)
            function truncateWords(text, maxWords) {
                const words = text.split(' ');
                if (words.length <= maxWords) return text;
                return words.slice(0, maxWords).join(' ');
            }
            
            // Criar array combinado de label, valor e cor, e ordenar por valor (maior primeiro)
            const combined = categoryLabels.map((label, i) => ({
                label: label,
                value: categoryData[i],
                color: categoryColors[i]
            }));
            combined.sort((a, b) => b.value - a.value); // Ordenar do maior para menor
            
            // Fun√ß√£o para criar/atualizar a legenda com a cor correta
            function updateLegend() {
                const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
                const textColor = isDarkMode ? '#FFFFFF' : '#2d3748';
                const isMobile = window.innerWidth < 768;
                
                let legendHTML = '';
                combined.forEach((item) => {
                    // No mobile, limitar a 2 palavras
                    const displayLabel = isMobile ? truncateWords(item.label, 2) : item.label;
                    legendHTML += `
                        <div style="display: flex; align-items: center; gap: 6px; color: ${textColor};" title="${item.label}">
                            <span style="width: 10px; height: 10px; border-radius: 50%; background-color: ${item.color}; flex-shrink: 0;"></span>
                            <span style="color: ${textColor}; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${displayLabel}</span>
                        </div>
                    `;
                });
                legendContainer.innerHTML = legendHTML;
                console.log('‚úÖ Legenda customizada atualizada (cor: ' + textColor + ', mobile: ' + isMobile + ')');
            }
            
            // Criar legenda inicial
            updateLegend();
            
            // Atualizar ao redimensionar janela
            window.addEventListener('resize', updateLegend);
            
            // Observar mudan√ßas no atributo data-theme
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'data-theme') {
                        updateLegend();
                    }
                });
            });
            
            observer.observe(document.documentElement, {
                attributes: true,
                attributeFilter: ['data-theme']
            });
            
            console.log('‚úÖ Legenda customizada criada com ' + categoryLabels.length + ' itens em grid 2 colunas (ordenados por valor)');
        }
        
        console.log('‚úÖ Gr√°fico de categorias criado com sucesso!');
            }
        } else {
            console.error('‚ùå Canvas #categoryChart n√£o encontrado!');
        }
    } catch (error) {
        console.error('‚ùå ERRO ao criar gr√°fico de categorias:', error);
    }
    
    // Daily Chart
    const dailyCtx = document.getElementById('dailyChart');
    if (dailyCtx) {
        new Chart(dailyCtx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: {{ chart_days|safe }},
                datasets: [
                    {
                        label: 'Entradas',
                        data: {{ chart_daily_in|safe }},
                        backgroundColor: '#198754'
                    },
                    {
                        label: 'Sa√≠das',
                        data: {{ chart_daily_out|safe }},
                        backgroundColor: '#dc3545'
                    },
                    {
                        label: 'Saldo',
                        data: {{ chart_daily_bal|safe }},
                        backgroundColor: '#0d6efd'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }
    
    // ========================================
    // TABLE & MOBILE CARDS FILTER & SEARCH
    // ========================================
    const table = document.getElementById('lancamentos-table');
    const mobileCards = document.getElementById('mobile-cards');
    const searchInput = document.getElementById('search-input');
    const filterBtns = document.querySelectorAll('.btn-filter');
    
    // Get all filterable items (table rows and mobile cards)
    const tableRows = table ? Array.from(table.querySelectorAll('tbody tr[data-tipo]')) : [];
    const mobileItems = mobileCards ? Array.from(mobileCards.querySelectorAll('.mobile-transaction-card[data-tipo]')) : [];
    
    let currentFilter = 'all';
    
    function applyFilters() {
        const searchText = searchInput ? searchInput.value.toLowerCase() : '';
        
        // Filter table rows
        tableRows.forEach(row => {
            const tipo = row.dataset.tipo;
            const categoria = row.dataset.categoria || '';
            
            const matchesFilter = currentFilter === 'all' || tipo === currentFilter;
            const matchesSearch = !searchText || categoria.includes(searchText);
            
            row.style.display = matchesFilter && matchesSearch ? '' : 'none';
        });
        
        // Filter mobile cards
        mobileItems.forEach(card => {
            const tipo = card.dataset.tipo;
            const categoria = card.dataset.categoria || '';
            
            const matchesFilter = currentFilter === 'all' || tipo === currentFilter;
            const matchesSearch = !searchText || categoria.includes(searchText);
            
            card.style.display = matchesFilter && matchesSearch ? '' : 'none';
        });
    }
    
    filterBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            filterBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentFilter = this.dataset.filter;
            applyFilters();
        });
    });
    
    if (searchInput) {
        searchInput.addEventListener('input', applyFilters);
    }
});
</script>
{% endblock %}
