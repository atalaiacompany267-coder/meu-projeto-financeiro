{% extends "base.html" %}

{% block title %}Dashboard - Controle Financeiro{% endblock %}

{% block page_title %}Dashboard{% endblock %}

{% block navbar_extra %}
<form action="{{ url_for('dashboard') }}" method="GET" class="d-flex" style="display: flex !important; align-items: center !important; gap: 8px !important; margin: 0 !important; flex-shrink: 0 !important;">
    <input type="month" name="filtro_mes" class="form-control month-selector" value="{{ filtro_atual }}">
    <button class="btn btn-primary" type="submit" title="Filtrar">
        <i class="fas fa-filter"></i>
    </button>
</form>
{% endblock %}

{% block content %}
<style>
    /* ========================================
       TABELA RESPONSIVA - Dashboard
       ======================================== */
    
    /* For√ßar linha √∫nica na tabela */
    #lancamentos-table tbody tr td {
        white-space: nowrap !important;
        vertical-align: middle !important;
    }
    
    /* Coluna de valor - nunca quebra linha */
    .col-valor .valor-texto {
        white-space: nowrap !important;
    }
    
    /* Coluna de categoria com ellipsis */
    .col-categoria {
        max-width: 180px !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
    }
    
    .col-categoria .categoria-texto {
        display: inline-block;
        max-width: 100px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        vertical-align: middle;
    }
    
    /* Badge de meta */
    .badge-meta {
        font-size: 0.55rem !important;
        vertical-align: middle;
        padding: 0.15rem 0.35rem !important;
    }
    
    /* Bot√µes de a√ß√£o - SEMPRE em linha horizontal */
    .btn-group-acoes {
        display: inline-flex !important;
        flex-direction: row !important;
        flex-wrap: nowrap !important;
        gap: 3px !important;
        justify-content: center !important;
    }
    
    .btn-group-acoes .btn {
        flex-shrink: 0 !important;
        padding: 0.25rem 0.4rem !important;
    }
    
    .col-acoes {
        min-width: 100px !important;
        white-space: nowrap !important;
    }
    
    /* Formul√°rio de novo lan√ßamento responsivo */
    .form-novo-lancamento .row {
        display: flex;
        flex-wrap: wrap;
        align-items: flex-end;
    }
    
    /* ========================================
       TABLETS (768px - 1024px)
       ======================================== */
    @media (min-width: 768px) and (max-width: 1024px) {
        /* Esconde badge de meta em tablets menores */
        .badge-meta {
            display: none !important;
        }
        
        /* Categoria com menos largura */
        .col-categoria {
            max-width: 100px !important;
        }
        
        .col-categoria .categoria-texto {
            max-width: 80px;
        }
        
        /* Coluna de data mais compacta */
        .col-data {
            font-size: 0.8rem;
        }
        
        /* Bot√µes menores */
        .btn-group-acoes .btn {
            padding: 0.2rem 0.35rem !important;
            font-size: 0.7rem !important;
        }
        
        .col-acoes {
            min-width: 90px !important;
        }
    }
    
    /* ========================================
       TABLETS PEQUENOS / LANDSCAPE PHONES
       ======================================== */
    @media (max-width: 991px) {
        /* Esconde badge de meta */
        .badge-meta {
            display: none !important;
        }
        
        /* Coluna de categoria mais estreita */
        .col-categoria .categoria-texto {
            max-width: 70px;
        }
    }
    
    /* ========================================
       MOBILE - Esconde tabela, mostra cards
       ======================================== */
    @media (max-width: 767px) {
        .desktop-table {
            display: none !important;
        }
        
        .mobile-transaction-cards {
            display: block !important;
        }
    }
    
    @media (min-width: 768px) {
        .mobile-transaction-cards {
            display: none !important;
        }
    }
</style>

<!-- Stats Cards - Responsive Grid com Espa√ßamento Adequado -->
<div class="row g-2 g-md-4" style="margin-bottom: 2rem !important;">
        <div class="col-12 col-sm-4">
            <div class="card stat-card entrada">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start flex-column flex-sm-row">
                        <div class="flex-grow-1" style="min-width: 0;">
                            <p class="stat-label mb-1">Entradas</p>
                            <h3 class="stat-value privacy-mask mb-0" style="font-size: clamp(0.9rem, 3.5vw, 1.5rem) !important; font-weight: 800 !important; line-height: 1.2 !important; white-space: nowrap !important;">R$ {{ "%.2f"|format(entrada) }}</h3>
                            <small class="text-{{ 'success' if trend_ent_pct > 0 else 'danger' }} d-none d-md-inline">
                                <i class="fas fa-arrow-{{ 'up' if trend_ent_pct > 0 else 'down' }}"></i>
                                {{ "%.0f"|format(trend_ent_pct|abs) }}%
                            </small>
                        </div>
                        <div class="stat-icon d-none d-sm-flex">
                            <i class="fas fa-arrow-up"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-4">
            <div class="card stat-card saida">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start flex-column flex-sm-row">
                        <div class="flex-grow-1" style="min-width: 0;">
                            <p class="stat-label mb-1">Sa√≠das</p>
                            <h3 class="stat-value privacy-mask mb-0" style="font-size: clamp(0.9rem, 3.5vw, 1.5rem) !important; font-weight: 800 !important; line-height: 1.2 !important; white-space: nowrap !important;">R$ {{ "%.2f"|format(saida|abs) }}</h3>
                            <small class="text-{{ 'danger' if trend_sai_pct > 0 else 'success' }} d-none d-md-inline">
                                <i class="fas fa-arrow-{{ 'up' if trend_sai_pct > 0 else 'down' }}"></i>
                                {{ "%.0f"|format(trend_sai_pct|abs) }}%
                            </small>
                        </div>
                        <div class="stat-icon d-none d-sm-flex">
                            <i class="fas fa-arrow-down"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-4">
            <div class="card stat-card saldo">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start flex-column flex-sm-row">
                        <div class="flex-grow-1" style="min-width: 0;">
                            <p class="stat-label mb-1">Saldo</p>
                            <h3 class="stat-value privacy-mask mb-0 text-{{ 'success' if saldo >= 0 else 'danger' }}" style="font-size: clamp(0.9rem, 3.5vw, 1.5rem) !important; font-weight: 800 !important; line-height: 1.2 !important; white-space: nowrap !important;">
                                R$ {{ "%.2f"|format(saldo) }}
                            </h3>
                            <small class="text-muted d-none d-md-inline">M√©dia: R$ {{ "%.0f"|format(avg_ent - avg_sai) }}</small>
                        </div>
                        <div class="stat-icon d-none d-sm-flex">
                            <i class="fas fa-wallet"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- Charts Row -->
<div class="row g-4 mb-4">
    <!-- Category Chart -->
    <div class="col-lg-5">
        <div class="card h-100">
            <div class="card-header">
                <i class="fas fa-chart-pie me-2"></i>Gastos por Categoria
            </div>
            <div class="card-body">
                <div style="height: 250px;">
                    <canvas id="categoryChart"></canvas>
                </div>
                
                <!-- Macro Summary (50-30-20) -->
                <div class="mt-4 pt-3" style="border-top: 1px solid var(--border-color);">
                    <h6 class="mb-3">Regra 50-30-20</h6>
                    {% set tot = entrada if entrada > 0 else 1 %}
                    
                    <div class="mb-2">
                        <div class="d-flex justify-content-between small mb-1">
                            <span>Essenciais (50%)</span>
                            <span class="privacy-mask">{{ "%.0f"|format((macro_vals['ESSENCIAIS']/tot)*100) }}%</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-danger" style="width: {{ (macro_vals['ESSENCIAIS']/tot)*100 }}%"></div>
                        </div>
                    </div>
                    
                    <div class="mb-2">
                        <div class="d-flex justify-content-between small mb-1">
                            <span>Estilo de Vida (30%)</span>
                            <span class="privacy-mask">{{ "%.0f"|format((macro_vals['ESTILO_VIDA']/tot)*100) }}%</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-warning" style="width: {{ (macro_vals['ESTILO_VIDA']/tot)*100 }}%"></div>
                        </div>
                    </div>
                    
                    <div class="mb-2">
                        <div class="d-flex justify-content-between small mb-1">
                            <span>Investimentos (20%)</span>
                            <span class="privacy-mask">{{ "%.0f"|format((macro_vals['INVESTIMENTOS']/tot)*100) }}%</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-success" style="width: {{ (macro_vals['INVESTIMENTOS']/tot)*100 }}%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Daily Chart -->
    <div class="col-lg-7">
        <div class="card h-100">
            <div class="card-header">
                <i class="fas fa-chart-bar me-2"></i>Movimenta√ß√£o Di√°ria
            </div>
            <div class="card-body">
                <div style="height: 340px;">
                    <canvas id="dailyChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Transaction Form -->
<div class="card mb-4">
    <div class="card-header">
        <i class="fas fa-plus-circle me-2"></i>Novo Lan√ßamento
    </div>
    <div class="card-body">
        <form action="{{ url_for('add_lancamento') }}" method="POST">
            <div class="row g-3">
                <div class="col-md-2">
                    <label class="form-label">Data</label>
                    <input type="text" name="data" class="form-control date-mask" value="{{ hoje_br }}" required>
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label">Tipo</label>
                    <select name="tipo" class="form-select">
                        <option value="SAIDA">Sa√≠da</option>
                        <option value="ENTRADA">Entrada</option>
                    </select>
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label">Categoria</label>
                    <input name="categoria" class="form-control" list="categorias-list" required placeholder="Ex: Mercado">
                    <datalist id="categorias-list">
                        {% for cat in all_categories %}
                        <option value="{{ cat }}">
                        {% endfor %}
                    </datalist>
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label">Classifica√ß√£o</label>
                    <select name="classificacao" class="form-select">
                        <option value="Essenciais">Essenciais</option>
                        <option value="Estilo de Vida">Estilo de Vida</option>
                        <option value="Investimentos">Investimentos</option>
                    </select>
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label">Valor (R$)</label>
                    <input type="number" step="0.01" name="valor" class="form-control" required placeholder="0.00">
                </div>
                <div class="col-12 col-md-2">
                    <label class="form-label">Vincular Meta</label>
                    <select name="meta_id" class="form-select">
                        <option value="">Nenhuma</option>
                        {% for meta in metas_dropdown %}
                        <option value="{{ meta[0] }}">
                            {{ meta[1] }}{% if meta[2] == 'quitar' %} (D√≠vida){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-12 col-md-1 d-flex align-items-end">
                    <button type="submit" class="btn btn-success w-100">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Transactions Section -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
        <span><i class="fas fa-list me-2"></i>Lan√ßamentos</span>
        <div class="d-flex gap-2 align-items-center flex-wrap">
            <input type="text" id="search-input" class="form-control form-control-sm" placeholder="Buscar..." style="width: 150px;">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-secondary btn-filter btn-sm active" data-filter="all">Todos</button>
                <button type="button" class="btn btn-outline-secondary btn-filter btn-sm" data-filter="ENTRADA"><span class="d-none d-sm-inline">Entradas</span><span class="d-sm-none">+</span></button>
                <button type="button" class="btn btn-outline-secondary btn-filter btn-sm" data-filter="SAIDA"><span class="d-none d-sm-inline">Sa√≠das</span><span class="d-sm-none">-</span></button>
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        <!-- Desktop Table View -->
        <div class="table-responsive desktop-table">
            <table class="table table-hover mb-0" id="lancamentos-table">
                <thead>
                    <tr>
                        <th style="width: 50px;" class="text-center">
                            <i class="fas fa-check-circle"></i>
                        </th>
                        <th>Data</th>
                        <th>Tipo</th>
                        <th>Categoria</th>
                        <th class="text-end col-valor">Valor</th>
                        <th class="text-center col-acoes">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for l in dados_exibicao %}
                    <tr class="{% if l.Status == 'Pago' %}row-pago{% endif %}" 
                        data-tipo="{{ l.Tipo }}" 
                        data-categoria="{{ l.Categoria|lower }}" 
                        data-descricao="{{ l.Descri√ß√£o|lower }}">
                        <td class="text-center">
                            <a href="{{ url_for('toggle_status', id=l.ID, filtro_mes=filtro_atual) }}" 
                               class="btn-status {% if l.Status == 'Pago' %}pago{% endif %}">
                                <i class="fas fa-check"></i>
                            </a>
                        </td>
                        <td class="col-data">{{ l.Data }}</td>
                        <td>
                            <span class="badge badge-{{ 'entrada' if l.Tipo == 'ENTRADA' else 'saida' }}">
                                {{ l.Tipo }}
                            </span>
                        </td>
                        <td class="col-categoria">
                            <span class="categoria-texto">{{ l.Categoria }}</span>
                            {% if l.MetaID %}
                            <span class="badge bg-{{ 'danger' if l.MetaTipo == 'quitar' else 'success' }} ms-1 badge-meta" 
                                  title="Vinculado a: {{ l.MetaNome }}">
                                <i class="fas fa-{{ 'file-invoice-dollar' if l.MetaTipo == 'quitar' else 'piggy-bank' }} me-1"></i>{{ l.MetaNome|truncate(15) }}
                            </span>
                            {% endif %}
                        </td>
                        <td class="text-end col-valor privacy-mask fw-bold text-{{ 'success' if l.Valor > 0 else 'danger' }}">
                            <span class="valor-texto">R$&nbsp;{{ "%.2f"|format(l.Valor|abs) }}</span>
                        </td>
                        <td class="text-center col-acoes">
                            <div class="btn-group-acoes">
                                <a href="{{ url_for('pin_lancamento', lancamento_id=l.ID, filtro_mes=filtro_atual) }}" 
                                   class="btn btn-action btn-outline-warning btn-pin {% if l.Fixado == 'Sim' %}fixado{% endif %}" 
                                   title="Fixar">
                                    <i class="fas fa-thumbtack"></i>
                                </a>
                                <a href="{{ url_for('edit_lancamento_form', lancamento_id=l.ID, filtro_mes=filtro_atual) }}" 
                                   class="btn btn-action btn-outline-primary" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a href="{{ url_for('delete_lancamento', lancamento_id=l.ID, filtro_mes=filtro_atual) }}" 
                                   class="btn btn-action btn-outline-danger" 
                                   onclick="return confirm('Excluir este lan√ßamento?')" title="Excluir">
                                    <i class="fas fa-trash"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                            Nenhum lan√ßamento neste m√™s
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Mobile Cards View -->
        <div class="mobile-transaction-cards p-3" id="mobile-cards">
            {% for l in dados_exibicao %}
            <div class="mobile-transaction-card {{ 'entrada' if l.Tipo == 'ENTRADA' else 'saida' }} {% if l.Status == 'Pago' %}opacity-75{% endif %}"
                 data-tipo="{{ l.Tipo }}" 
                 data-categoria="{{ l.Categoria|lower }}" 
                 data-descricao="{{ l.Descri√ß√£o|lower }}">
                <div class="transaction-header">
                    <div class="transaction-desc">
                        {{ l.Descri√ß√£o or l.Categoria }}
                        {% if l.Fixado == 'Sim' %}
                        <i class="fas fa-thumbtack text-warning ms-1" style="font-size: 0.7rem;"></i>
                        {% endif %}
                    </div>
                    <div class="transaction-valor privacy-mask text-{{ 'success' if l.Valor > 0 else 'danger' }}">
                        {{ '+' if l.Valor > 0 else '-' }}R$ {{ "%.2f"|format(l.Valor|abs) }}
                    </div>
                </div>
                {% if l.MetaID %}
                <div class="mb-1">
                    <span class="badge bg-{{ 'danger' if l.MetaTipo == 'quitar' else 'success' }}" 
                          style="font-size: 0.6rem;">
                        <i class="fas fa-{{ 'file-invoice-dollar' if l.MetaTipo == 'quitar' else 'piggy-bank' }} me-1"></i>{{ l.MetaNome }}
                    </span>
                </div>
                {% endif %}
                <div class="transaction-meta">
                    <span><i class="fas fa-calendar"></i> {{ l.Data }}</span>
                    <span><i class="fas fa-tag"></i> {{ l.Categoria }}</span>
                    {% if l.Status == 'Pago' %}
                    <span class="text-success"><i class="fas fa-check-circle"></i> Pago</span>
                    {% endif %}
                </div>
                <div class="transaction-actions">
                    <a href="{{ url_for('toggle_status', id=l.ID, filtro_mes=filtro_atual) }}" 
                       class="btn btn-sm btn-outline-{{ 'success' if l.Status != 'Pago' else 'secondary' }}" 
                       title="{{ 'Marcar como pago' if l.Status != 'Pago' else 'Marcar como pendente' }}">
                        <i class="fas fa-check"></i>
                    </a>
                    <a href="{{ url_for('pin_lancamento', lancamento_id=l.ID, filtro_mes=filtro_atual) }}" 
                       class="btn btn-sm btn-outline-warning" title="Fixar">
                        <i class="fas fa-thumbtack"></i>
                    </a>
                    <a href="{{ url_for('edit_lancamento_form', lancamento_id=l.ID, filtro_mes=filtro_atual) }}" 
                       class="btn btn-sm btn-outline-primary" title="Editar">
                        <i class="fas fa-edit"></i>
                    </a>
                    <a href="{{ url_for('delete_lancamento', lancamento_id=l.ID, filtro_mes=filtro_atual) }}" 
                       class="btn btn-sm btn-outline-danger" 
                       onclick="return confirm('Excluir?')" title="Excluir">
                        <i class="fas fa-trash"></i>
                    </a>
                </div>
            </div>
            {% else %}
            <div class="text-center text-muted py-4">
                <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                Nenhum lan√ßamento neste m√™s
            </div>
            {% endfor %}
        </div>
    </div>
</div>

{% if ask_to_generate %}
<!-- Modal para gerar fixos -->
<div class="modal fade" id="gerarFixosModal" tabindex="-1" aria-labelledby="gerarFixosModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Gerar Lan√ßamentos Fixos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Deseja gerar os lan√ßamentos fixos para <strong>{{ mes_extenso }}</strong>?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Agora n√£o</button>
                <a href="{{ url_for('gerar_fixos_cmd', mes=filtro_atual) }}" class="btn btn-success">
                    <i class="fas fa-sync me-1"></i> Gerar Agora
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ P√°gina carregada - Inicializando gr√°ficos...');
    
    // ========================================
    // CHARTS
    // ========================================
    
    // Paleta de cores EXPANDIDA - 10 cores distintas para evitar repeti√ß√£o
    const colorPalette = [
        '#3498db', // Azul
        '#2ecc71', // Verde
        '#f1c40f', // Amarelo
        '#e74c3c', // Vermelho
        '#9b59b6', // Roxo
        '#1abc9c', // Turquesa
        '#e67e22', // Laranja
        '#34495e', // Cinza escuro
        '#7f8c8d', // Cinza m√©dio
        '#d35400'  // Laranja escuro
    ];
    
    console.log('‚úÖ Paleta de cores definida:', colorPalette);
    
    // Fun√ß√£o para distribuir cores
    function getChartColors(count) {
        const colors = [];
        for (let i = 0; i < count; i++) {
            colors.push(colorPalette[i % colorPalette.length]);
        }
        return colors;
    }
    
    // Category Chart - Gr√°fico de Gastos por Categoria
    try {
        const categoryCtx = document.getElementById('categoryChart');
        if (categoryCtx) {
            console.log('üìä Canvas encontrado:', categoryCtx);
            
            const categoryLabels = {{ chart_cats|safe }};
            const categoryData = {{ chart_vals|safe }};
            
            console.log('üìä GR√ÅFICO DE CATEGORIAS:');
            console.log('  - Labels:', categoryLabels);
            console.log('  - Valores:', categoryData);
            console.log('  - Total de categorias:', categoryLabels.length);
            
            if (categoryLabels.length === 0 || categoryData.length === 0) {
                console.warn('‚ö†Ô∏è Sem dados para o gr√°fico de categorias');
            } else {
                const categoryColors = getChartColors(categoryLabels.length);
                console.log('  - Cores aplicadas:', categoryColors);
                
                // Detectar tema atual para contraste
                const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
                const textColor = isDarkMode ? '#f8f9fa' : '#2d3748';
                const borderColor = 'transparent'; // Sem bordas brancas
                
                console.log('  - Tema:', isDarkMode ? 'Escuro' : 'Claro');
                console.log('  - Cor de texto:', textColor);
                
                new Chart(categoryCtx.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: categoryLabels,
                datasets: [{
                    data: categoryData,
                    backgroundColor: categoryColors,
                    borderColor: borderColor,
                    borderWidth: 0,
                    hoverOffset: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            padding: 15,
                            usePointStyle: true,
                            font: {
                                size: 12,
                                weight: '500'
                            },
                            boxWidth: 12,
                            boxHeight: 12,
                            color: textColor
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        titleFont: {
                            size: 14,
                            weight: 'bold'
                        },
                        bodyFont: {
                            size: 13
                        },
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${label}: R$ ${value.toFixed(2)} (${percentage}%)`;
                            }
                        }
                    }
                },
                cutout: '60%'
            }
        });
        
        console.log('‚úÖ Gr√°fico de categorias criado com sucesso!');
            }
        } else {
            console.error('‚ùå Canvas #categoryChart n√£o encontrado!');
        }
    } catch (error) {
        console.error('‚ùå ERRO ao criar gr√°fico de categorias:', error);
    }
    
    // Daily Chart
    const dailyCtx = document.getElementById('dailyChart');
    if (dailyCtx) {
        new Chart(dailyCtx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: {{ chart_days|safe }},
                datasets: [
                    {
                        label: 'Entradas',
                        data: {{ chart_daily_in|safe }},
                        backgroundColor: '#198754'
                    },
                    {
                        label: 'Sa√≠das',
                        data: {{ chart_daily_out|safe }},
                        backgroundColor: '#dc3545'
                    },
                    {
                        label: 'Saldo',
                        data: {{ chart_daily_bal|safe }},
                        backgroundColor: '#0d6efd'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }
    
    // ========================================
    // TABLE & MOBILE CARDS FILTER & SEARCH
    // ========================================
    const table = document.getElementById('lancamentos-table');
    const mobileCards = document.getElementById('mobile-cards');
    const searchInput = document.getElementById('search-input');
    const filterBtns = document.querySelectorAll('.btn-filter');
    
    // Get all filterable items (table rows and mobile cards)
    const tableRows = table ? Array.from(table.querySelectorAll('tbody tr[data-tipo]')) : [];
    const mobileItems = mobileCards ? Array.from(mobileCards.querySelectorAll('.mobile-transaction-card[data-tipo]')) : [];
    
    let currentFilter = 'all';
    
    function applyFilters() {
        const searchText = searchInput ? searchInput.value.toLowerCase() : '';
        
        // Filter table rows
        tableRows.forEach(row => {
            const tipo = row.dataset.tipo;
            const categoria = row.dataset.categoria || '';
            const descricao = row.dataset.descricao || '';
            
            const matchesFilter = currentFilter === 'all' || tipo === currentFilter;
            const matchesSearch = !searchText || categoria.includes(searchText) || descricao.includes(searchText);
            
            row.style.display = matchesFilter && matchesSearch ? '' : 'none';
        });
        
        // Filter mobile cards
        mobileItems.forEach(card => {
            const tipo = card.dataset.tipo;
            const categoria = card.dataset.categoria || '';
            const descricao = card.dataset.descricao || '';
            
            const matchesFilter = currentFilter === 'all' || tipo === currentFilter;
            const matchesSearch = !searchText || categoria.includes(searchText) || descricao.includes(searchText);
            
            card.style.display = matchesFilter && matchesSearch ? '' : 'none';
        });
    }
    
    filterBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            filterBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentFilter = this.dataset.filter;
            applyFilters();
        });
    });
    
    if (searchInput) {
        searchInput.addEventListener('input', applyFilters);
    }
    
    {% if ask_to_generate %}
    // Show modal to generate fixed expenses
    const modal = new bootstrap.Modal(document.getElementById('gerarFixosModal'));
    modal.show();
    {% endif %}
});
</script>
{% endblock %}
