{% extends "base.html" %}

{% block title %}Dashboard - Controle Financeiro{% endblock %}

{% block page_title %}Dashboard{% endblock %}

{% block navbar_extra %}
<form action="{{ url_for('dashboard') }}" method="GET" class="d-flex filter-form-dashboard" id="filterFormDashboard" style="display: flex !important; align-items: center !important; gap: 8px !important; margin: 0 !important; flex-shrink: 0 !important;">
    <input type="month" name="filtro_mes" class="form-control" value="{{ filtro_atual }}" onchange="this.form.submit()">
    <button class="btn btn-primary filter-submit-btn" type="submit" title="Filtrar">
        <i class="fas fa-filter"></i>
    </button>
</form>
{% endblock %}

{% block content %}
<style>
    /* ========================================
       ESTILIZA√á√ÉO DE ENTRADAS E SA√çDAS
       Padr√£o id√™ntico √† p√°gina de Lan√ßamentos Fixos
       ======================================== */
    
    /* Coluna Tipo */
    .col-tipo {
        width: 100px !important;
        white-space: nowrap !important;
    }
    
    /* Badge de Tipo - Estilo P√≠lula (id√™ntico ao Fixos) */
    .badge-entrada {
        background: rgba(25, 135, 84, 0.2) !important;
        color: #2ecc71 !important;
        padding: 0.4em 0.8em !important;
        border-radius: 20px !important;
        font-weight: 600 !important;
        font-size: 0.75rem !important;
        text-transform: uppercase !important;
        letter-spacing: 0.5px !important;
    }
    
    .badge-saida {
        background: rgba(220, 53, 69, 0.2) !important;
        color: #ff4d4d !important;
        padding: 0.4em 0.8em !important;
        border-radius: 20px !important;
        font-weight: 600 !important;
        font-size: 0.75rem !important;
        text-transform: uppercase !important;
        letter-spacing: 0.5px !important;
    }
    
    /* Valores coloridos - Entrada (Verde) - FOR√áADO */
    .valor-entrada,
    .valor-entrada .valor-texto,
    td.valor-entrada,
    td.valor-entrada span {
        color: #2ecc71 !important;
    }
    
    /* Valores coloridos - Sa√≠da (Vermelho) - FOR√áADO */
    .valor-saida,
    .valor-saida .valor-texto,
    td.valor-saida,
    td.valor-saida span {
        color: #e74c3c !important;
    }
    
    /* Modo Escuro - Melhor contraste */
    [data-theme="dark"] .badge-entrada {
        background: rgba(46, 204, 113, 0.2) !important;
        color: #5dfc9e !important;
    }
    
    [data-theme="dark"] .badge-saida {
        background: rgba(255, 77, 77, 0.2) !important;
        color: #ff6b6b !important;
    }
    
    [data-theme="dark"] .valor-entrada,
    [data-theme="dark"] .valor-entrada .valor-texto,
    [data-theme="dark"] td.valor-entrada,
    [data-theme="dark"] td.valor-entrada span {
        color: #2ecc71 !important;
    }
    
    [data-theme="dark"] .valor-saida,
    [data-theme="dark"] .valor-saida .valor-texto,
    [data-theme="dark"] td.valor-saida,
    [data-theme="dark"] td.valor-saida span {
        color: #e74c3c !important;
    }
    
    /* ========================================
       FORMUL√ÅRIO DASHBOARD - CONFORT√ÅVEL E LEG√çVEL
       Fontes maiores, campos espa√ßados, bot√£o full-width
       ======================================== */
    
    /* Desktop: Formul√°rio confort√°vel */
    form[action*="add_lancamento"] .form-label {
        font-size: 0.9rem;
        font-weight: 500;
        margin-bottom: 0.4rem;
        color: var(--text-primary);
    }
    
    form[action*="add_lancamento"] .form-control,
    form[action*="add_lancamento"] .form-select {
        font-size: 1rem;
        padding: 0.6rem 0.75rem;
        height: auto;
        min-height: 42px;
    }
    
    /* Bot√£o sempre full-width e destacado */
    form[action*="add_lancamento"] button[type="submit"] {
        width: 100% !important;
        min-height: 50px !important;
        font-size: 1.1rem !important;
        font-weight: 600 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        gap: 10px !important;
        border-radius: 8px !important;
        margin-top: 0.5rem;
    }
    
    /* Mobile e Tablet */
    @media (max-width: 991px) {
        form[action*="add_lancamento"] .row {
            display: flex !important;
            flex-wrap: wrap !important;
            gap: 0.75rem !important;
        }
        
        /* Campos em pares */
        form[action*="add_lancamento"] .row > .col-6 {
            flex: 0 0 calc(50% - 0.375rem) !important;
            width: calc(50% - 0.375rem) !important;
            max-width: calc(50% - 0.375rem) !important;
        }
        
        /* Campo Valor: Largura total */
        form[action*="add_lancamento"] .row > div.col-12:not(:last-child) {
            flex: 0 0 100% !important;
            width: 100% !important;
        }
        
        /* Bot√£o: Linha exclusiva */
        form[action*="add_lancamento"] .row > div.col-12.mt-2,
        form[action*="add_lancamento"] .row > .col-12:last-of-type {
            flex: 0 0 100% !important;
            width: 100% !important;
            margin-top: 1rem !important;
        }
    }
    
    /* Mobile: Fontes confort√°veis */
    @media (max-width: 767px) {
        form[action*="add_lancamento"] .form-label {
            font-size: 0.875rem;
            margin-bottom: 0.35rem;
        }
        
        form[action*="add_lancamento"] .form-control,
        form[action*="add_lancamento"] .form-select {
            font-size: 1rem;
            padding: 0.55rem 0.65rem;
            min-height: 44px;
        }
        
        form[action*="add_lancamento"] button[type="submit"] {
            min-height: 52px !important;
            font-size: 1.05rem !important;
        }
    }
    
    /* ========================================
       LEGENDA CUSTOMIZADA DO GR√ÅFICO - GRID 2 COLUNAS IGUAIS
       TEXTO BRANCO NO MODO ESCURO (#FFFFFF)
       ======================================== */
    
    /* Container da legenda customizada - GRID 2 COLUNAS EQUILIBRADAS */
    #categoryLegend {
        display: grid !important;
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 8px 12px !important;
        align-content: start !important;
        justify-items: start !important;
    }
    
    /* Itens da legenda - DIN√ÇMICO: Preto no modo claro, Branco no modo escuro */
    #categoryLegend div {
        display: flex !important;
        align-items: center !important;
        gap: 6px !important;
        font-size: 11px !important;
        width: 100% !important;
        max-width: 100% !important;
        overflow: hidden !important;
    }
    
    /* Bolinha colorida da legenda */
    #categoryLegend div span:first-child {
        width: 10px !important;
        height: 10px !important;
        min-width: 10px !important;
        min-height: 10px !important;
        border-radius: 50% !important;
        flex-shrink: 0 !important;
    }
    
    /* Texto da legenda - Modo claro: preto */
    #categoryLegend div,
    #categoryLegend div span:last-child {
        color: #2d3748 !important;
    }
    
    /* Texto da categoria - truncar com ellipsis */
    #categoryLegend div span:last-child {
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        max-width: calc(100% - 20px) !important;
    }
    
    /* Modo escuro: texto BRANCO FOR√áADO */
    [data-theme="dark"] #categoryLegend div,
    [data-theme="dark"] #categoryLegend div span:last-child {
        color: #FFFFFF !important;
    }
    
    /* Mobile: ajustes de tamanho */
    @media (max-width: 767px) {
        #categoryLegend {
            gap: 5px 8px !important;
        }
        
        #categoryLegend div {
            font-size: 9px !important;
        }
        
        #categoryLegend div span:first-child {
            width: 8px !important;
            height: 8px !important;
            min-width: 8px !important;
            min-height: 8px !important;
        }
        
        #categoryLegend div span:last-child {
            max-width: calc(100% - 16px) !important;
        }
    }
    
    /* ========================================
       TABELA RESPONSIVA - Dashboard
       ======================================== */
    
    /* For√ßar linha √∫nica na tabela */
    #lancamentos-table tbody tr td {
        white-space: nowrap !important;
        vertical-align: middle !important;
    }
    
    /* Coluna de valor - nunca quebra linha */
    .col-valor .valor-texto {
        white-space: nowrap !important;
    }
    
    /* Coluna de categoria - SEM cortar texto na tabela */
    .col-categoria {
        max-width: 180px !important;
        overflow: visible !important;
    }
    
    .col-categoria .categoria-texto {
        display: inline-block;
        max-width: 100px;
        white-space: nowrap;
        overflow: visible !important;
        vertical-align: middle;
    }
    
    /* Badge de meta */
    .badge-meta {
        font-size: 0.55rem !important;
        vertical-align: middle;
        padding: 0.15rem 0.35rem !important;
    }
    
    /* Bot√µes de a√ß√£o - SEMPRE em linha horizontal */
    .btn-group-acoes {
        display: inline-flex !important;
        flex-direction: row !important;
        flex-wrap: nowrap !important;
        gap: 3px !important;
        justify-content: center !important;
    }
    
    .btn-group-acoes .btn {
        flex-shrink: 0 !important;
        padding: 0.25rem 0.4rem !important;
    }
    
    .col-acoes {
        min-width: 100px !important;
        white-space: nowrap !important;
    }
    
    /* ========================================
       FORMUL√ÅRIO DE NOVO LAN√áAMENTO - RESPONSIVO
       Desktop: Grid 3 colunas
       Tablet: Grid 2 colunas
       Mobile: Grid 2 ou 1 coluna
       ======================================== */
    
    /* ========================================
       DESKTOP (> 1024px) - Grid 3 Colunas
       ======================================== */
    @media (min-width: 1025px) {
        /* Desktop: Grid de 3 colunas */
        form[action*="add_lancamento"] .row {
            display: grid !important;
            grid-template-columns: repeat(3, 1fr) !important;
            gap: 15px !important;
            align-items: start !important;
        }
        
        /* Cada campo ocupa 1 coluna */
        form[action*="add_lancamento"] .col-md-2,
        form[action*="add_lancamento"] .col-md-1,
        form[action*="add_lancamento"] .col-6,
        form[action*="add_lancamento"] .col-12 {
            grid-column: span 1 !important;
            width: 100% !important;
            max-width: none !important;
        }
        
        /* Bot√£o: ocupa 3 colunas (largura total) */
        form[action*="add_lancamento"] .col-md-1:last-child {
            grid-column: span 3 !important;
        }
        
        /* Labels: alinhados √† esquerda, acima do campo */
        form[action*="add_lancamento"] .form-label {
            font-size: 0.875rem !important;
            font-weight: 500 !important;
            margin-bottom: 0.4rem !important;
            text-align: left !important;
            display: block !important;
        }
        
        /* Padroniza√ß√£o dos inputs e selects */
        form[action*="add_lancamento"] .form-control,
        form[action*="add_lancamento"] .form-select {
            width: 100% !important;
            height: 40px !important;
            max-width: none !important;
            font-size: 0.9rem !important;
            padding: 0.5rem 0.75rem !important;
            border-radius: 6px !important;
            box-sizing: border-box !important;
        }
        
        /* Bot√£o adicionar: grande, verde, retangular, √≠cone centralizado */
        form[action*="add_lancamento"] button[type="submit"] {
            width: 100% !important;
            height: 48px !important;
            padding: 0 1.5rem !important;
            font-size: 1.1rem !important;
            font-weight: 700 !important;
            background-color: #28a745 !important;
            border-color: #28a745 !important;
            color: white !important;
            border-radius: 8px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 10px !important;
        }
        
        form[action*="add_lancamento"] button[type="submit"]:hover {
            background-color: #218838 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.35);
        }
        
        form[action*="add_lancamento"] button[type="submit"] i {
            font-size: 1.3rem !important;
        }
    }
    
    /* ========================================
       TABLETS (768px - 1024px) - Grid 2 Colunas
       ======================================== */
    @media (min-width: 768px) and (max-width: 1024px) {
        /* Tablet: Grid de 2 colunas */
        form[action*="add_lancamento"] .row {
            display: grid !important;
            grid-template-columns: 1fr 1fr !important;
            gap: 15px !important;
            align-items: start !important;
        }
        
        /* Cada campo ocupa 1 coluna */
        form[action*="add_lancamento"] .col-md-2,
        form[action*="add_lancamento"] .col-md-1,
        form[action*="add_lancamento"] .col-6,
        form[action*="add_lancamento"] .col-12 {
            grid-column: span 1 !important;
            width: 100% !important;
            max-width: none !important;
        }
        
        /* Bot√£o: ocupa 2 colunas (largura total) */
        form[action*="add_lancamento"] .col-md-1:last-child {
            grid-column: span 2 !important;
        }
        
        /* Labels: alinhados √† esquerda, acima do campo */
        form[action*="add_lancamento"] .form-label {
            font-size: 0.875rem !important;
            font-weight: 500 !important;
            margin-bottom: 0.4rem !important;
            text-align: left !important;
            display: block !important;
        }
        
        /* Padroniza√ß√£o dos inputs e selects */
        form[action*="add_lancamento"] .form-control,
        form[action*="add_lancamento"] .form-select {
            width: 100% !important;
            height: 40px !important;
            max-width: none !important;
            font-size: 0.9rem !important;
            padding: 0.5rem 0.75rem !important;
            border-radius: 6px !important;
            box-sizing: border-box !important;
        }
        
        /* Bot√£o adicionar: grande, verde, retangular, √≠cone centralizado */
        form[action*="add_lancamento"] button[type="submit"] {
            width: 100% !important;
            height: 48px !important;
            padding: 0 1.5rem !important;
            font-size: 1.1rem !important;
            font-weight: 700 !important;
            background-color: #28a745 !important;
            border-color: #28a745 !important;
            color: white !important;
            border-radius: 8px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 10px !important;
        }
        
        form[action*="add_lancamento"] button[type="submit"]:hover {
            background-color: #218838 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.35);
        }
        
        form[action*="add_lancamento"] button[type="submit"] i {
            font-size: 1.3rem !important;
        }
        
        /* Esconde badge de meta em tablets menores */
        .badge-meta {
            display: none !important;
        }
        
        /* Categoria com menos largura */
        .col-categoria {
            max-width: 100px !important;
        }
        
        .col-categoria .categoria-texto {
            max-width: 80px;
        }
        
        /* Coluna de data mais compacta */
        .col-data {
            font-size: 0.8rem;
        }
        
        /* Bot√µes menores */
        .btn-group-acoes .btn {
            padding: 0.2rem 0.35rem !important;
            font-size: 0.7rem !important;
        }
        
        .col-acoes {
            min-width: 90px !important;
        }
    }
    
    /* ========================================
       TABLETS PEQUENOS / LANDSCAPE PHONES
       ======================================== */
    @media (max-width: 991px) {
        /* Formul√°rio compacto */
        form[action*="add_lancamento"] .form-label {
            font-size: 0.75rem !important;
        }
        
        form[action*="add_lancamento"] .form-control,
        form[action*="add_lancamento"] .form-select {
            font-size: 0.8rem !important;
        }
        
        /* Esconde badge de meta */
        .badge-meta {
            display: none !important;
        }
        
        /* Coluna de categoria mais estreita */
        .col-categoria .categoria-texto {
            max-width: 70px;
        }
    }
    
    /* ========================================
       MOBILE M√âDIO (480px - 767px)
       CSS do formul√°rio gerenciado no topo
       ======================================== */
    @media (min-width: 480px) and (max-width: 767px) {
        /* FORMUL√ÅRIO - CSS REMOVIDO (usado CSS no topo do arquivo) */
    }
    
    /* ========================================
       MOBILE PEQUENO (< 480px)
       CSS do formul√°rio gerenciado no topo
       ======================================== */
    @media (max-width: 479px) {
        /* FORMUL√ÅRIO - CSS REMOVIDO (usado CSS no topo do arquivo) */
        
        /* Esconder tabela, mostrar cards */
        .desktop-table {
            display: none !important;
        }
        
        .mobile-transaction-cards {
            display: block !important;
        }
        
        /* Cabe√ßalho Dashboard - iPhone Ultra-Compacto */
        .page-title-section h1 {
            font-size: 1.4rem !important;
        }
        
        .page-title-section .text-muted {
            font-size: 0.8rem !important;
        }
        
        /* √çCONES COLADOS - gap 2px, SEM margin-left: auto */
        .navbar-actions {
            gap: 2px !important;
            margin-left: 0 !important;
            margin-right: 0 !important;
            padding-right: 0 !important;
        }
        
        .top-navbar {
            justify-content: space-between !important;
            padding-left: 0.5rem !important;
            padding-right: 0.5rem !important;
            width: 100% !important;
        }
        
        .top-navbar .d-flex.align-items-center.gap-3 {
            gap: 4px !important;
            flex-shrink: 0 !important;
            margin-right: 0 !important;
        }
        
        /* Bot√µes menores no cabe√ßalho mobile */
        .btn-privacy-toggle,
        .btn-theme-toggle,
        .btn-actions-toggle {
            padding: 0.25rem 0.4rem !important;
            font-size: 0.8rem !important;
            width: 32px !important;
            height: 32px !important;
            min-width: 32px !important;
        }
        
        /* Form do filtro mais compacto */
        form[action*="dashboard"] {
            gap: 2px !important;
        }
        
        .navbar .month-selector,
        .month-selector {
            max-width: 95px !important;
            font-size: 0.7rem !important;
            padding: 0.2rem 0.35rem !important;
        }
        
        form[action*="dashboard"] .btn-primary {
            padding: 0.3rem 0.5rem !important;
            font-size: 0.85rem !important;
        }
        
        /* FORMUL√ÅRIO MOBILE - CSS REMOVIDO (usado CSS no topo do arquivo) */
        
        form[action*="add_lancamento"] .form-label {
            font-size: 0.7rem !important;
            margin-bottom: 0.2rem !important;
        }
    }
    
    @media (min-width: 768px) {
        .mobile-transaction-cards {
            display: none !important;
        }
        
        /* Formul√°rio PC: 3 colunas x 2 linhas */
        form[action*="add_lancamento"] .row {
            display: grid !important;
            grid-template-columns: repeat(3, 1fr) !important;
            gap: 1rem !important;
            align-items: start !important;
        }
        
        /* Data, Tipo, Categoria - Linha 1 */
        form[action*="add_lancamento"] .col-6:nth-child(1),
        form[action*="add_lancamento"] .col-6:nth-child(2),
        form[action*="add_lancamento"] .col-6:nth-child(3) {
            grid-column: span 1 !important;
        }
        
        /* Classifica√ß√£o, Valor, Meta - Linha 2 */
        form[action*="add_lancamento"] .col-6:nth-child(4),
        form[action*="add_lancamento"] .col-6:nth-child(5),
        form[action*="add_lancamento"] .col-12:nth-child(6) {
            grid-column: span 1 !important;
        }
        
        /* Bot√£o (+) - Linha 3, largura total */
        form[action*="add_lancamento"] .col-12:last-child {
            grid-column: span 3 !important;
        }
    }
</style>

<!-- Stats Cards - Responsive Grid com Espa√ßamento Adequado -->
<div class="row g-2 g-md-4" style="margin-bottom: 2rem !important;">
        <div class="col-12 col-sm-4">
            <div class="card stat-card entrada">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start flex-column flex-sm-row">
                        <div class="flex-grow-1" style="min-width: 0;">
                            <p class="stat-label mb-1">Entradas</p>
                            <h3 class="stat-value privacy-mask mb-0" style="font-size: clamp(0.9rem, 3.5vw, 1.5rem) !important; font-weight: 800 !important; line-height: 1.2 !important; white-space: nowrap !important;">R$ {{ "%.2f"|format(entrada) }}</h3>
                            <small class="d-none d-md-inline" style="color: #ffffff !important;">
                                <i class="fas fa-arrow-{{ 'up' if trend_ent_pct > 0 else 'down' }}"></i>
                                {{ "%.0f"|format(trend_ent_pct|abs) }}%
                            </small>
                        </div>
                        <div class="stat-icon d-none d-sm-flex">
                            <i class="fas fa-arrow-up"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-4">
            <div class="card stat-card saida">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start flex-column flex-sm-row">
                        <div class="flex-grow-1" style="min-width: 0;">
                            <p class="stat-label mb-1">Sa√≠das</p>
                            <h3 class="stat-value privacy-mask mb-0" style="font-size: clamp(0.9rem, 3.5vw, 1.5rem) !important; font-weight: 800 !important; line-height: 1.2 !important; white-space: nowrap !important;">R$ {{ "%.2f"|format(saida|abs) }}</h3>
                            <small class="d-none d-md-inline" style="color: #ffffff !important;">
                                <i class="fas fa-arrow-{{ 'up' if trend_sai_pct > 0 else 'down' }}"></i>
                                {{ "%.0f"|format(trend_sai_pct|abs) }}%
                            </small>
                        </div>
                        <div class="stat-icon d-none d-sm-flex">
                            <i class="fas fa-arrow-down"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-4">
            <div class="card stat-card saldo">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start flex-column flex-sm-row">
                        <div class="flex-grow-1" style="min-width: 0;">
                            <p class="stat-label mb-1">Saldo</p>
                            <h3 class="stat-value privacy-mask mb-0" style="font-size: clamp(0.9rem, 3.5vw, 1.5rem) !important; font-weight: 800 !important; line-height: 1.2 !important; white-space: nowrap !important; color: #ffffff !important;">
                                R$ {{ "%.2f"|format(saldo) }}
                            </h3>
                        </div>
                        <div class="stat-icon d-none d-sm-flex">
                            <i class="fas fa-wallet"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- Charts Row -->
<div class="row g-4 mb-4">
    <!-- Category Chart -->
    <div class="col-lg-5">
        <div class="card h-100">
            <div class="card-header">
                <i class="fas fa-chart-pie me-2"></i>Gastos por Categoria
            </div>
            <div class="card-body">
                <div class="d-flex align-items-start" style="gap: 15px;">
                    <!-- Gr√°fico de Pizza -->
                    <div style="width: 45%; min-width: 120px; height: 200px;">
                        <canvas id="categoryChart"></canvas>
                    </div>
                    <!-- Legenda Customizada em Grid 2 Colunas -->
                    <div id="categoryLegend" style="flex: 1; display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; align-content: start;"></div>
                </div>
                
                <!-- Macro Summary (50-30-20) -->
                <div class="mt-4 pt-3" style="border-top: 1px solid var(--border-color);">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <h6 class="mb-0">Regra <span id="regra-titulo">{{ meta_essencial }}-{{ meta_estilo }}-{{ meta_investimento }}</span></h6>
                        <button type="button" class="btn btn-link btn-sm p-0 text-muted" onclick="abrirModalMetas()" title="Editar metas">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                    </div>
                    {% set tot = entrada if entrada > 0 else 1 %}
                    
                    <div class="mb-2">
                        <div class="d-flex justify-content-between small mb-1">
                            <span>Essenciais (<span class="meta-essencial-display">{{ meta_essencial }}</span>%)</span>
                            <span class="privacy-mask">{{ "%.0f"|format((macro_vals['ESSENCIAIS']/tot)*100) }}%</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-danger" style="width: {{ (macro_vals['ESSENCIAIS']/tot)*100 }}%"></div>
                        </div>
                    </div>
                    
                    <div class="mb-2">
                        <div class="d-flex justify-content-between small mb-1">
                            <span>Estilo de Vida (<span class="meta-estilo-display">{{ meta_estilo }}</span>%)</span>
                            <span class="privacy-mask">{{ "%.0f"|format((macro_vals['ESTILO_VIDA']/tot)*100) }}%</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-warning" style="width: {{ (macro_vals['ESTILO_VIDA']/tot)*100 }}%"></div>
                        </div>
                    </div>
                    
                    <div class="mb-2">
                        <div class="d-flex justify-content-between small mb-1">
                            <span>Investimentos (<span class="meta-investimento-display">{{ meta_investimento }}</span>%)</span>
                            <span class="privacy-mask">{{ "%.0f"|format((macro_vals['INVESTIMENTOS']/tot)*100) }}%</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-success" style="width: {{ (macro_vals['INVESTIMENTOS']/tot)*100 }}%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Daily Chart -->
    <div class="col-lg-7">
        <div class="card h-100">
            <div class="card-header">
                <i class="fas fa-chart-bar me-2"></i>Movimenta√ß√£o Di√°ria
            </div>
            <div class="card-body">
                <div style="height: 340px;">
                    <canvas id="dailyChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Transaction Form -->
<div class="card mb-4">
    <div class="card-header">
        <i class="fas fa-plus-circle me-2"></i>Novo Lan√ßamento
    </div>
    <div class="card-body">
        <form action="{{ url_for('add_lancamento') }}" method="POST">
            <div class="row g-3">
                <!-- Linha 1: Data | Tipo -->
                <div class="col-6 col-md-4 col-lg-2">
                    <label class="form-label">Data</label>
                    <input type="text" name="data" class="form-control date-mask" value="{{ hoje_br }}" required>
                </div>
                <div class="col-6 col-md-4 col-lg-2">
                    <label class="form-label">Tipo</label>
                    <select name="tipo" class="form-select">
                        <option value="SAIDA">Sa√≠da</option>
                        <option value="ENTRADA">Entrada</option>
                    </select>
                </div>
                <!-- Linha 2: Classifica√ß√£o | Categoria -->
                <div class="col-6 col-md-4 col-lg-2">
                    <label class="form-label">Classifica√ß√£o</label>
                    <select name="classificacao" class="form-select">
                        <option value="Essenciais">Essenciais</option>
                        <option value="Estilo de Vida">Estilo de Vida</option>
                        <option value="Investimentos">Investimentos</option>
                    </select>
                </div>
                <div class="col-6 col-md-6 col-lg-3">
                    <label class="form-label">Categoria</label>
                    <input name="categoria" class="form-control" list="categorias-list" required placeholder="Ex: Mercado">
                    <datalist id="categorias-list">
                        {% for cat in all_categories %}
                        <option value="{{ cat }}">
                        {% endfor %}
                    </datalist>
                </div>
                <!-- Linha 3: Valor -->
                <div class="col-12 col-md-6 col-lg-3">
                    <label class="form-label">Valor (R$)</label>
                    <input type="number" step="0.01" name="valor" class="form-control" required placeholder="0.00">
                </div>
                <!-- V√≠nculo de Meta (opcional) -->
                <input type="hidden" name="meta_id" value="">
                <!-- Linha Final: Bot√£o Full-Width -->
                <div class="col-12 mt-2">
                    <button type="submit" class="btn w-100" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: none; color: #ffffff; font-weight: 600; font-size: 1.1rem; min-height: 50px;">
                        <i class="fas fa-plus me-2"></i>Adicionar Lan√ßamento
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Transactions Section -->
    </div>
</div>

<!-- Transactions Section -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
        <span><i class="fas fa-list me-2"></i>Lan√ßamentos</span>
        <div class="d-flex gap-2 align-items-center flex-wrap">
            <input type="text" id="search-input" class="form-control form-control-sm" placeholder="Buscar..." style="width: 150px;">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-secondary btn-filter btn-sm active" data-filter="all">Todos</button>
                <button type="button" class="btn btn-outline-secondary btn-filter btn-sm" data-filter="ENTRADA"><span class="d-none d-sm-inline">Entradas</span><span class="d-sm-none">+</span></button>
                <button type="button" class="btn btn-outline-secondary btn-filter btn-sm" data-filter="SAIDA"><span class="d-none d-sm-inline">Sa√≠das</span><span class="d-sm-none">-</span></button>
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        <!-- Desktop Table View -->
        <div class="table-responsive desktop-table">
            <table class="table table-hover mb-0" id="lancamentos-table">
                <thead>
                    <tr>
                        <th style="width: 50px;" class="text-center">
                            <i class="fas fa-check-circle"></i>
                        </th>
                        <th class="text-center" style="width: 100px;">Tipo</th>
                        <th>Lan√ßamento</th>
                        <th>Classifica√ß√£o</th>
                        <th>Data</th>
                        <th class="text-end col-valor">Valor</th>
                        <th class="text-center col-acoes">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for l in dados_exibicao %}
                    <tr class="{% if l.Status == 'Pago' %}row-pago{% endif %}" 
                        data-tipo="{{ l.Tipo }}" 
                        data-categoria="{{ l.Categoria|lower }}">
                        <td class="text-center">
                            <a href="{{ url_for('toggle_status', id=l.ID, filtro_mes=filtro_atual) }}" 
                               class="btn-status {% if l.Status == 'Pago' %}pago{% endif %}">
                                <i class="fas fa-check"></i>
                            </a>
                        </td>
                        <td class="text-center">
                            <span class="badge badge-{{ 'entrada' if l.Tipo == 'ENTRADA' else 'saida' }}">
                                {{ 'ENTRADA' if l.Tipo == 'ENTRADA' else 'SA√çDA' }}
                            </span>
                        </td>
                        <td class="col-categoria">
                            <span class="categoria-texto">{{ l.Categoria }}</span>
                        </td>
                        <td class="col-classificacao">
                            {% if l.Classifica√ß√£o == 'Essenciais' %}
                            <span class="badge" style="background: rgba(108, 117, 125, 0.2); color: #6c757d;">Essenciais</span>
                            {% elif l.Classifica√ß√£o == 'Estilo de Vida' %}
                            <span class="badge" style="background: rgba(255, 193, 7, 0.2); color: #ffc107;">Estilo de Vida</span>
                            {% else %}
                            <span class="badge" style="background: rgba(13, 110, 253, 0.2); color: #0d6efd;">Investimentos</span>
                            {% endif %}
                        </td>
                        <td class="col-data">{{ l.Data }}</td>
                        <td class="text-end col-valor privacy-mask fw-bold" style="color: {% if l.Tipo == 'ENTRADA' %}#2ecc71{% else %}#e74c3c{% endif %} !important;">
                            <span class="valor-texto" style="color: {% if l.Tipo == 'ENTRADA' %}#2ecc71{% else %}#e74c3c{% endif %} !important;">R$&nbsp;{{ "%.2f"|format(l.Valor|abs) }}</span>
                        </td>
                        <td class="text-center col-acoes">
                            <div class="btn-group-acoes">
                                <a href="{{ url_for('pin_lancamento', lancamento_id=l.ID, filtro_mes=filtro_atual) }}" 
                                   class="btn btn-action btn-warning btn-pin {% if l.Fixado == 'Sim' %}fixado{% endif %}" 
                                   title="Fixar">
                                    <i class="fas fa-thumbtack"></i>
                                </a>
                                <a href="{{ url_for('edit_lancamento_form', lancamento_id=l.ID, filtro_mes=filtro_atual) }}" 
                                   class="btn btn-action btn-primary" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a href="{{ url_for('delete_lancamento', lancamento_id=l.ID, filtro_mes=filtro_atual) }}" 
                                   class="btn btn-action btn-danger" 
                                   title="Excluir">
                                    <i class="fas fa-trash"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                            Nenhum lan√ßamento neste m√™s
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Mobile Cards View -->
        <div class="mobile-transaction-cards p-3" id="mobile-cards">
            {% for l in dados_exibicao %}
            <div class="mobile-transaction-card {{ 'entrada' if l.Tipo == 'ENTRADA' else 'saida' }} {% if l.Status == 'Pago' %}opacity-75{% endif %}"
                 data-tipo="{{ l.Tipo }}" 
                 data-categoria="{{ l.Categoria|lower }}">
                <div class="transaction-header">
                    <div class="transaction-desc">
                        {{ l.Categoria }}
                        <span class="badge badge-{{ 'entrada' if l.Tipo == 'ENTRADA' else 'saida' }} ms-2">{{ 'ENTRADA' if l.Tipo == 'ENTRADA' else 'SA√çDA' }}</span>
                    </div>
                    <div class="transaction-valor privacy-mask fw-bold" style="color: {% if l.Tipo == 'ENTRADA' %}#2ecc71{% else %}#e74c3c{% endif %} !important;">
                        R$ {{ "%.2f"|format(l.Valor|abs) }}
                    </div>
                </div>
                <div class="transaction-meta">
                    <span><i class="fas fa-calendar"></i> {{ l.Data }}</span>
                    <span>
                        {% if l.Classifica√ß√£o == 'Essenciais' %}
                        <i class="fas fa-home" style="color: #6c757d;"></i> Essenciais
                        {% elif l.Classifica√ß√£o == 'Estilo de Vida' %}
                        <i class="fas fa-heart" style="color: #ffc107;"></i> Estilo de Vida
                        {% else %}
                        <i class="fas fa-chart-line" style="color: #0d6efd;"></i> Investimentos
                        {% endif %}
                    </span>
                    {% if l.Status == 'Pago' %}
                    <span class="text-success"><i class="fas fa-check-circle"></i> Pago</span>
                    {% else %}
                    <span class="text-warning"><i class="fas fa-clock"></i> Pendente</span>
                    {% endif %}
                </div>
                <div class="transaction-actions">
                    <a href="{{ url_for('toggle_status', id=l.ID, filtro_mes=filtro_atual) }}" 
                       class="btn btn-sm btn-{{ 'success' if l.Status != 'Pago' else 'secondary' }}" 
                       title="{{ 'Marcar como pago' if l.Status != 'Pago' else 'Marcar como pendente' }}">
                        <i class="fas fa-check"></i>
                    </a>
                    <a href="{{ url_for('pin_lancamento', lancamento_id=l.ID, filtro_mes=filtro_atual) }}" 
                       class="btn btn-sm btn-warning" title="Fixar">
                        <i class="fas fa-thumbtack"></i>
                    </a>
                    <a href="{{ url_for('edit_lancamento_form', lancamento_id=l.ID, filtro_mes=filtro_atual) }}" 
                       class="btn btn-sm btn-primary" title="Editar">
                        <i class="fas fa-edit"></i>
                    </a>
                    <a href="{{ url_for('delete_lancamento', lancamento_id=l.ID, filtro_mes=filtro_atual) }}" 
                       class="btn btn-sm btn-danger" 
                       title="Excluir">
                        <i class="fas fa-trash"></i>
                    </a>
                </div>
            </div>
            {% else %}
            <div class="text-center text-muted py-4">
                <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                Nenhum lan√ßamento neste m√™s
            </div>
            {% endfor %}
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ P√°gina carregada - Inicializando gr√°ficos...');
    
    // ========================================
    // CHARTS
    // ========================================
    
    // Paleta de cores EXPANDIDA - 10 cores distintas para evitar repeti√ß√£o
    const colorPalette = [
        '#3498db', // Azul
        '#2ecc71', // Verde
        '#f1c40f', // Amarelo
        '#e74c3c', // Vermelho
        '#9b59b6', // Roxo
        '#1abc9c', // Turquesa
        '#e67e22', // Laranja
        '#34495e', // Cinza escuro
        '#7f8c8d', // Cinza m√©dio
        '#d35400'  // Laranja escuro
    ];
    
    console.log('‚úÖ Paleta de cores definida:', colorPalette);
    
    // Fun√ß√£o para distribuir cores
    function getChartColors(count) {
        const colors = [];
        for (let i = 0; i < count; i++) {
            colors.push(colorPalette[i % colorPalette.length]);
        }
        return colors;
    }
    
    // Category Chart - Gr√°fico de Gastos por Categoria
    try {
        const categoryCtx = document.getElementById('categoryChart');
        if (categoryCtx) {
            console.log('üìä Canvas encontrado:', categoryCtx);
            
            const categoryLabels = {{ chart_cats|safe }};
            const categoryData = {{ chart_vals|safe }};
            
            console.log('üìä GR√ÅFICO DE CATEGORIAS:');
            console.log('  - Labels:', categoryLabels);
            console.log('  - Valores:', categoryData);
            console.log('  - Total de categorias:', categoryLabels.length);
            
            if (categoryLabels.length === 0 || categoryData.length === 0) {
                console.warn('‚ö†Ô∏è Sem dados para o gr√°fico de categorias');
            } else {
                const categoryColors = getChartColors(categoryLabels.length);
                console.log('  - Cores aplicadas:', categoryColors);
                
                // Criar gr√°fico sem legenda nativa
                
                new Chart(categoryCtx.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: categoryLabels,
                datasets: [{
                    data: categoryData,
                    backgroundColor: categoryColors,
                    borderColor: 'transparent',
                    borderWidth: 0,
                    hoverOffset: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false // Desabilitar legenda nativa - usaremos HTML customizado
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        titleFont: {
                            size: 14,
                            weight: 'bold'
                        },
                        bodyFont: {
                            size: 13
                        },
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${label}: R$ ${value.toFixed(2)} (${percentage}%)`;
                            }
                        }
                    }
                },
                cutout: '60%'
            }
        });
        
        // CRIAR LEGENDA HTML CUSTOMIZADA com Grid 2 Colunas Exatas
        const legendContainer = document.getElementById('categoryLegend');
        if (legendContainer) {
            // Fun√ß√£o para truncar texto em N palavras (mobile)
            function truncateWords(text, maxWords) {
                const words = text.split(' ');
                if (words.length <= maxWords) return text;
                return words.slice(0, maxWords).join(' ');
            }
            
            // Criar array combinado de label, valor e cor, e ordenar por valor (maior primeiro)
            const combined = categoryLabels.map((label, i) => ({
                label: label,
                value: categoryData[i],
                color: categoryColors[i]
            }));
            combined.sort((a, b) => b.value - a.value); // Ordenar do maior para menor
            
            // Fun√ß√£o para criar/atualizar a legenda com a cor correta
            function updateLegend() {
                const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
                const textColor = isDarkMode ? '#FFFFFF' : '#2d3748';
                const isMobile = window.innerWidth < 768;
                
                let legendHTML = '';
                combined.forEach((item) => {
                    // No mobile, limitar a 2 palavras
                    const displayLabel = isMobile ? truncateWords(item.label, 2) : item.label;
                    legendHTML += `
                        <div style="display: flex; align-items: center; gap: 6px; color: ${textColor};" title="${item.label}">
                            <span style="width: 10px; height: 10px; border-radius: 50%; background-color: ${item.color}; flex-shrink: 0;"></span>
                            <span style="color: ${textColor}; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${displayLabel}</span>
                        </div>
                    `;
                });
                legendContainer.innerHTML = legendHTML;
                console.log('‚úÖ Legenda customizada atualizada (cor: ' + textColor + ', mobile: ' + isMobile + ')');
            }
            
            // Criar legenda inicial
            updateLegend();
            
            // Atualizar ao redimensionar janela
            window.addEventListener('resize', updateLegend);
            
            // Observar mudan√ßas no atributo data-theme
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'data-theme') {
                        updateLegend();
                    }
                });
            });
            
            observer.observe(document.documentElement, {
                attributes: true,
                attributeFilter: ['data-theme']
            });
            
            console.log('‚úÖ Legenda customizada criada com ' + categoryLabels.length + ' itens em grid 2 colunas (ordenados por valor)');
        }
        
        console.log('‚úÖ Gr√°fico de categorias criado com sucesso!');
            }
        } else {
            console.error('‚ùå Canvas #categoryChart n√£o encontrado!');
        }
    } catch (error) {
        console.error('‚ùå ERRO ao criar gr√°fico de categorias:', error);
    }
    
    // Daily Chart
    const dailyCtx = document.getElementById('dailyChart');
    if (dailyCtx) {
        new Chart(dailyCtx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: {{ chart_days|safe }},
                datasets: [
                    {
                        label: 'Entradas',
                        data: {{ chart_daily_in|safe }},
                        backgroundColor: '#198754'
                    },
                    {
                        label: 'Sa√≠das',
                        data: {{ chart_daily_out|safe }},
                        backgroundColor: '#dc3545'
                    },
                    {
                        label: 'Saldo',
                        data: {{ chart_daily_bal|safe }},
                        backgroundColor: '#0d6efd'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }
    
    // ========================================
    // TABLE & MOBILE CARDS FILTER & SEARCH
    // ========================================
    const table = document.getElementById('lancamentos-table');
    const mobileCards = document.getElementById('mobile-cards');
    const searchInput = document.getElementById('search-input');
    const filterBtns = document.querySelectorAll('.btn-filter');
    
    // Get all filterable items (table rows and mobile cards)
    const tableRows = table ? Array.from(table.querySelectorAll('tbody tr[data-tipo]')) : [];
    const mobileItems = mobileCards ? Array.from(mobileCards.querySelectorAll('.mobile-transaction-card[data-tipo]')) : [];
    
    let currentFilter = 'all';
    
    function applyFilters() {
        const searchText = searchInput ? searchInput.value.toLowerCase() : '';
        
        // Filter table rows
        tableRows.forEach(row => {
            const tipo = row.dataset.tipo;
            const categoria = row.dataset.categoria || '';
            
            const matchesFilter = currentFilter === 'all' || tipo === currentFilter;
            const matchesSearch = !searchText || categoria.includes(searchText);
            
            row.style.display = matchesFilter && matchesSearch ? '' : 'none';
        });
        
        // Filter mobile cards
        mobileItems.forEach(card => {
            const tipo = card.dataset.tipo;
            const categoria = card.dataset.categoria || '';
            
            const matchesFilter = currentFilter === 'all' || tipo === currentFilter;
            const matchesSearch = !searchText || categoria.includes(searchText);
            
            card.style.display = matchesFilter && matchesSearch ? '' : 'none';
        });
    }
    
    filterBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            filterBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentFilter = this.dataset.filter;
            applyFilters();
        });
    });
    
    if (searchInput) {
        searchInput.addEventListener('input', applyFilters);
    }
});
</script>

<!-- ============================================ -->
<!-- CSS DO MODAL - CORES ADAPT√ÅVEIS AO TEMA -->
<!-- ============================================ -->
<style>
/* =============================================
   MODAL METAS - Z-INDEX M√ÅXIMO
   ============================================= */
#modalEditarMetas {
    z-index: 99999 !important;
    position: fixed !important;
}

#modalEditarMetas .modal-dialog {
    z-index: 100000 !important;
    pointer-events: auto !important;
}

#modalEditarMetas .modal-content {
    z-index: 100001 !important;
    pointer-events: auto !important;
}

/* Backdrop customizado */
.modal-backdrop.show {
    z-index: 99998 !important;
}

/* =============================================
   TEMA CLARO (Light Mode) - CORES DO MODAL
   ============================================= */
#modalEditarMetas .modal-content {
    background-color: #ffffff !important;
    color: #212529 !important;
    border: 1px solid #dee2e6 !important;
    box-shadow: 0 15px 50px rgba(0, 0, 0, 0.3) !important;
    border-radius: 12px !important;
}

#modalEditarMetas .modal-header {
    background-color: #f8f9fa !important;
    border-bottom: 1px solid #dee2e6 !important;
    border-radius: 11px 11px 0 0 !important;
}

#modalEditarMetas .modal-title {
    color: #212529 !important;
    font-weight: 600 !important;
}

#modalEditarMetas .modal-body {
    background-color: #ffffff !important;
    color: #212529 !important;
}

#modalEditarMetas .modal-footer {
    background-color: #f8f9fa !important;
    border-top: 1px solid #dee2e6 !important;
    border-radius: 0 0 11px 11px !important;
}

#modalEditarMetas .form-label {
    color: #212529 !important;
    font-weight: 500 !important;
}

#modalEditarMetas .form-control {
    background-color: #ffffff !important;
    color: #212529 !important;
    border: 1px solid #ced4da !important;
    pointer-events: auto !important;
    cursor: text !important;
}

#modalEditarMetas .form-control:focus {
    background-color: #ffffff !important;
    color: #212529 !important;
    border-color: #10b981 !important;
    box-shadow: 0 0 0 0.25rem rgba(16, 185, 129, 0.25) !important;
    outline: none !important;
}

#modalEditarMetas .input-group-text {
    background-color: #e9ecef !important;
    color: #212529 !important;
    border: 1px solid #ced4da !important;
}

#modalEditarMetas .alert-info {
    background-color: #cff4fc !important;
    color: #055160 !important;
    border-color: #b6effb !important;
}

#modalEditarMetas .btn-close {
    filter: none !important;
    opacity: 0.7 !important;
    pointer-events: auto !important;
    cursor: pointer !important;
}

#modalEditarMetas .btn-close:hover {
    opacity: 1 !important;
}

/* =============================================
   TEMA ESCURO (Dark Mode) - CORES DO MODAL
   ============================================= */
[data-theme="dark"] #modalEditarMetas .modal-content {
    background-color: #1a1a1a !important;
    color: #f8f9fa !important;
    border: 1px solid #3d3d3d !important;
    box-shadow: 0 15px 50px rgba(0, 0, 0, 0.6) !important;
}

[data-theme="dark"] #modalEditarMetas .modal-header {
    background-color: #0d0d0d !important;
    border-bottom: 1px solid #3d3d3d !important;
}

[data-theme="dark"] #modalEditarMetas .modal-title {
    color: #f8f9fa !important;
}

[data-theme="dark"] #modalEditarMetas .modal-body {
    background-color: #1a1a1a !important;
    color: #f8f9fa !important;
}

[data-theme="dark"] #modalEditarMetas .modal-footer {
    background-color: #0d0d0d !important;
    border-top: 1px solid #3d3d3d !important;
}

[data-theme="dark"] #modalEditarMetas .form-label {
    color: #f8f9fa !important;
}

[data-theme="dark"] #modalEditarMetas .form-control {
    background-color: #2d2d2d !important;
    color: #f8f9fa !important;
    border: 1px solid #4d4d4d !important;
}

[data-theme="dark"] #modalEditarMetas .form-control:focus {
    background-color: #2d2d2d !important;
    color: #f8f9fa !important;
    border-color: #10b981 !important;
    box-shadow: 0 0 0 0.25rem rgba(16, 185, 129, 0.35) !important;
}

[data-theme="dark"] #modalEditarMetas .input-group-text {
    background-color: #3d3d3d !important;
    color: #f8f9fa !important;
    border: 1px solid #4d4d4d !important;
}

[data-theme="dark"] #modalEditarMetas .alert-info {
    background-color: #1a3a4a !important;
    color: #7dd3fc !important;
    border-color: #2d4a5a !important;
}

[data-theme="dark"] #modalEditarMetas .btn-close {
    filter: invert(1) grayscale(100%) brightness(200%) !important;
}

/* =============================================
   BOT√ïES DO MODAL - SEMPRE FUNCIONAIS
   ============================================= */
#modalEditarMetas .btn {
    pointer-events: auto !important;
    cursor: pointer !important;
    position: relative !important;
    z-index: 100002 !important;
}

#modalEditarMetas .btn-secondary {
    background-color: #6c757d !important;
    border-color: #6c757d !important;
    color: #ffffff !important;
}

#modalEditarMetas .btn-secondary:hover {
    background-color: #5c636a !important;
    border-color: #565e64 !important;
}

#modalEditarMetas .btn-success {
    background-color: #10b981 !important;
    border-color: #10b981 !important;
    color: #ffffff !important;
}

#modalEditarMetas .btn-success:hover:not(:disabled) {
    background-color: #059669 !important;
    border-color: #059669 !important;
}

#modalEditarMetas .btn-success:disabled {
    background-color: #6c757d !important;
    border-color: #6c757d !important;
    opacity: 0.65 !important;
    cursor: not-allowed !important;
}

/* =============================================
   GARANTIR INPUTS CLIC√ÅVEIS
   ============================================= */
#modalEditarMetas input[type="number"] {
    -webkit-appearance: none !important;
    -moz-appearance: textfield !important;
    appearance: textfield !important;
    pointer-events: auto !important;
    cursor: text !important;
    user-select: auto !important;
    -webkit-user-select: auto !important;
}

#modalEditarMetas input[type="number"]::-webkit-inner-spin-button,
#modalEditarMetas input[type="number"]::-webkit-outer-spin-button {
    -webkit-appearance: inner-spin-button !important;
    opacity: 1 !important;
}

/* Alerta de erro visual */
#modalEditarMetas .alerta-erro-modal {
    display: none;
    background-color: #f8d7da !important;
    color: #842029 !important;
    border-color: #f5c2c7 !important;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 0.85rem;
    margin-top: 10px;
    text-align: center;
}

[data-theme="dark"] #modalEditarMetas .alerta-erro-modal {
    background-color: #4a1a1a !important;
    color: #f8a5a5 !important;
    border-color: #6a2a2a !important;
}
</style>

<!-- ============================================ -->
<!-- MODAL EDITAR METAS - FORA DE QUALQUER CARD -->
<!-- ============================================ -->
<div class="modal fade" id="modalEditarMetas" tabindex="-1" aria-labelledby="modalEditarMetasLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h6 class="modal-title" id="modalEditarMetasLabel">
                    <i class="fas fa-sliders-h me-2"></i>Editar Metas
                </h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info py-2 small mb-3">
                    <i class="fas fa-info-circle me-1"></i>A soma deve ser <strong>100%</strong>
                </div>
                
                <div class="mb-3">
                    <label class="form-label small mb-1" for="input-meta-essencial">
                        <span class="text-danger">‚óè</span> Essenciais
                    </label>
                    <div class="input-group input-group-sm">
                        <input type="number" class="form-control" id="input-meta-essencial" 
                               value="{{ meta_essencial }}" min="0" max="100" step="1"
                               autocomplete="off">
                        <span class="input-group-text">%</span>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label small mb-1" for="input-meta-estilo">
                        <span class="text-warning">‚óè</span> Estilo de Vida
                    </label>
                    <div class="input-group input-group-sm">
                        <input type="number" class="form-control" id="input-meta-estilo" 
                               value="{{ meta_estilo }}" min="0" max="100" step="1"
                               autocomplete="off">
                        <span class="input-group-text">%</span>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label small mb-1" for="input-meta-investimento">
                        <span class="text-success">‚óè</span> Investimentos
                    </label>
                    <div class="input-group input-group-sm">
                        <input type="number" class="form-control" id="input-meta-investimento" 
                               value="{{ meta_investimento }}" min="0" max="100" step="1"
                               autocomplete="off">
                        <span class="input-group-text">%</span>
                    </div>
                </div>
                
                <div class="text-center mt-3">
                    <span id="soma-metas-display" class="badge bg-success fs-6">Total: 100%</span>
                </div>
                
                <!-- Alerta de erro visual dentro do modal -->
                <div id="alerta-erro-metas" class="alerta-erro-modal">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    <span id="msg-erro-metas">A soma deve ser 100%</span>
                </div>
            </div>
            <div class="modal-footer py-2">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal" id="btn-cancelar-metas">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-success btn-sm" id="btn-salvar-metas">
                    <i class="fas fa-save me-1"></i>Salvar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ============================================ -->
<!-- JAVASCRIPT DO MODAL - CORRIGIDO -->
<!-- ============================================ -->
<script>
(function() {
    'use strict';
    
    // Vari√°vel para inst√¢ncia do modal
    let modalMetasInstance = null;
    
    // Fun√ß√£o para abrir o modal
    window.abrirModalMetas = function() {
        console.log('Abrindo modal de metas...');
        
        const modalEl = document.getElementById('modalEditarMetas');
        if (!modalEl) {
            console.error('Modal #modalEditarMetas n√£o encontrado!');
            return;
        }
        
        // Verifica se Bootstrap est√° carregado
        if (typeof bootstrap === 'undefined' || !bootstrap.Modal) {
            console.error('Bootstrap Modal n√£o est√° dispon√≠vel!');
            alert('Erro: Bootstrap n√£o carregado. Recarregue a p√°gina.');
            return;
        }
        
        // Cria ou obt√©m inst√¢ncia do modal
        try {
            if (!modalMetasInstance) {
                modalMetasInstance = new bootstrap.Modal(modalEl, {
                    backdrop: true,
                    keyboard: true,
                    focus: true
                });
            }
            
            // Limpa alerta de erro
            esconderErroModal();
            
            // Valida soma antes de abrir
            validarSomaMetas();
            
            // Mostra o modal
            modalMetasInstance.show();
            console.log('Modal aberto com sucesso!');
            
        } catch (error) {
            console.error('Erro ao abrir modal:', error);
            alert('Erro ao abrir modal: ' + error.message);
        }
    };
    
    // Fun√ß√£o para fechar o modal
    window.fecharModalMetas = function() {
        if (modalMetasInstance) {
            modalMetasInstance.hide();
        }
    };
    
    // Fun√ß√£o para mostrar erro no modal
    function mostrarErroModal(mensagem) {
        const alertaEl = document.getElementById('alerta-erro-metas');
        const msgEl = document.getElementById('msg-erro-metas');
        if (alertaEl && msgEl) {
            msgEl.textContent = mensagem;
            alertaEl.style.display = 'block';
        }
    }
    
    // Fun√ß√£o para esconder erro no modal
    function esconderErroModal() {
        const alertaEl = document.getElementById('alerta-erro-metas');
        if (alertaEl) {
            alertaEl.style.display = 'none';
        }
    }
    
    // Fun√ß√£o para validar soma das metas
    window.validarSomaMetas = function() {
        const inputEssencial = document.getElementById('input-meta-essencial');
        const inputEstilo = document.getElementById('input-meta-estilo');
        const inputInvestimento = document.getElementById('input-meta-investimento');
        const display = document.getElementById('soma-metas-display');
        const btnSalvar = document.getElementById('btn-salvar-metas');
        
        if (!inputEssencial || !inputEstilo || !inputInvestimento) {
            console.error('Inputs do modal n√£o encontrados');
            return false;
        }
        
        const essencial = parseInt(inputEssencial.value) || 0;
        const estilo = parseInt(inputEstilo.value) || 0;
        const investimento = parseInt(inputInvestimento.value) || 0;
        const soma = essencial + estilo + investimento;
        
        // Atualiza display
        if (display) {
            display.textContent = `Total: ${soma}%`;
            
            if (soma === 100) {
                display.className = 'badge bg-success fs-6';
                esconderErroModal();
            } else {
                display.className = 'badge bg-danger fs-6';
                mostrarErroModal(`A soma est√° em ${soma}%. Deve ser exatamente 100%.`);
            }
        }
        
        // Habilita/desabilita bot√£o salvar
        if (btnSalvar) {
            btnSalvar.disabled = (soma !== 100);
        }
        
        return soma === 100;
    };
    
    // Fun√ß√£o para salvar metas
    window.salvarMetas = function() {
        console.log('Salvando metas...');
        
        const essencial = parseInt(document.getElementById('input-meta-essencial').value) || 0;
        const estilo = parseInt(document.getElementById('input-meta-estilo').value) || 0;
        const investimento = parseInt(document.getElementById('input-meta-investimento').value) || 0;
        const soma = essencial + estilo + investimento;
        
        // Valida√ß√£o final
        if (soma !== 100) {
            mostrarErroModal(`A soma √© ${soma}%. Ajuste para 100% antes de salvar.`);
            return;
        }
        
        // Refer√™ncia ao bot√£o
        const btnSalvar = document.getElementById('btn-salvar-metas');
        const originalText = btnSalvar ? btnSalvar.innerHTML : '';
        
        // Feedback visual
        if (btnSalvar) {
            btnSalvar.disabled = true;
            btnSalvar.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Salvando...';
        }
        
        // Enviar para o servidor
        fetch('/update_metas', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                meta_essencial: essencial,
                meta_estilo: estilo,
                meta_investimento: investimento
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Erro na resposta do servidor: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                console.log('Metas salvas com sucesso!');
                fecharModalMetas();
                // Recarrega a p√°gina para mostrar novos valores
                setTimeout(() => location.reload(), 300);
            } else {
                throw new Error(data.error || 'Erro desconhecido ao salvar');
            }
        })
        .catch(error => {
            console.error('Erro ao salvar:', error);
            mostrarErroModal('Erro: ' + error.message);
            
            if (btnSalvar) {
                btnSalvar.disabled = false;
                btnSalvar.innerHTML = originalText || '<i class="fas fa-save me-1"></i>Salvar';
            }
        });
    };
    
    // Configura eventos quando DOM estiver pronto
    function initModalMetas() {
        console.log('Inicializando modal de metas...');
        
        // Listeners para inputs (valida√ß√£o em tempo real)
        const inputIds = ['input-meta-essencial', 'input-meta-estilo', 'input-meta-investimento'];
        inputIds.forEach(id => {
            const input = document.getElementById(id);
            if (input) {
                // Remove listeners antigos para evitar duplica√ß√£o
                input.removeEventListener('input', validarSomaMetas);
                input.removeEventListener('change', validarSomaMetas);
                
                // Adiciona novos listeners
                input.addEventListener('input', validarSomaMetas);
                input.addEventListener('change', validarSomaMetas);
                
                console.log(`Listener adicionado ao input: ${id}`);
            } else {
                console.warn(`Input n√£o encontrado: ${id}`);
            }
        });
        
        // Listener para bot√£o Salvar
        const btnSalvar = document.getElementById('btn-salvar-metas');
        if (btnSalvar) {
            btnSalvar.removeEventListener('click', salvarMetas);
            btnSalvar.addEventListener('click', salvarMetas);
            console.log('Listener adicionado ao bot√£o Salvar');
        }
        
        // Listener para o modal (quando fecha, limpa estado)
        const modalEl = document.getElementById('modalEditarMetas');
        if (modalEl) {
            modalEl.addEventListener('hidden.bs.modal', function() {
                esconderErroModal();
                console.log('Modal fechado');
            });
        }
        
        console.log('Modal de metas inicializado com sucesso!');
    }
    
    // Inicializa quando DOM estiver pronto
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initModalMetas);
    } else {
        // DOM j√° est√° pronto
        initModalMetas();
    }
    
})();
</script>

{% endblock %}
